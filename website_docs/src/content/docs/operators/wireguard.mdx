---
title: "WireGuard Mesh Setup"
description: "Secure mesh networking for FrameWorks distributed architecture using WireGuard VPN."
sidebar:
  order: 11
---

import { Aside } from '@astrojs/starlight/components';

<Aside type="tip" title="Automated Setup Available">
**Privateer (`api_mesh`)** automates WireGuard mesh configuration for FrameWorks infrastructure nodes. It handles key exchange, peer discovery, and configuration management via Quartermaster. Status: **In Testing**.

This manual guide is for advanced users who need custom configurations or want to understand the underlying mesh architecture.
</Aside>

A robust mesh network is the backbone of any distributed system. FrameWorks uses WireGuard to create a secure, high-performance private network that connects all your backend services across different regions and clouds.

<Aside type="note">
The IP ranges and configs below are **examples**. If you use Privateer, prefer configuring the mesh via the `wireguard` section of your `cluster.yaml` and let Privateer manage peers.
</Aside>

<Aside type="note" title="Privateer uses a different mesh range">
Privateer (Quartermaster) currently allocates WireGuard IPs from **10.200.0.0/16**. The manual examples below use **10.18.0.0/16** from the deployment checklist. If you plan to move to Privateer later, either align your manual mesh to 10.200.0.0/16 now or be prepared to re-address the mesh.
</Aside>

## Overview

FrameWorks uses a WireGuard mesh to secure service-to-service traffic between backend infrastructure nodes (Central, Regional, and databases). A mesh is **required for multi-node backend clusters**. Single-node backend deployments can run without a mesh.

**Note:** Edge streaming nodes do not participate in this mesh.

### Network Architecture

The manual mesh uses a structured IP allocation for backend infrastructure:

```
10.18.0.0/16 - FrameWorks Manual WireGuard Mesh (Backend Infrastructure Only)
├── 10.18.0.x  - Central control nodes
├── 10.18.1.x  - Regional service nodes
├── 10.18.2.x  - YugabyteDB nodes
└── 10.18.3.x  - ClickHouse nodes
```

**Reserved for future tenant meshes (manual plan):** `10.19.0.0/16` (subdivide per tenant, e.g. `/20` blocks).

Edge streaming nodes are **not** part of this mesh—they communicate over the public internet.

## Installation

### Install WireGuard

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install wireguard wireguard-tools
```

**RHEL/CentOS:**
```bash
sudo dnf install wireguard-tools
# or
sudo yum install wireguard-tools
```

**Alpine Linux:**
```bash
apk add wireguard-tools
```

### Generate Keys

**On each node, generate key pairs:**

```bash
# Create WireGuard directory
sudo mkdir -p /etc/wireguard
cd /etc/wireguard

# Generate private key
sudo wg genkey > private.key
sudo chmod 600 private.key

# Generate public key
sudo wg pubkey < private.key > public.key

# Store keys securely
echo "Private key: $(sudo cat private.key)"
echo "Public key: $(sudo cat public.key)"
```

## Configuration

### Manual Mesh Template (Full Mesh)

Use a full mesh with **/32 AllowedIPs per peer**. Each node should only route its own WireGuard IP.

**Create `/etc/wireguard/wg0.conf` on each backend node:**

```ini
[Interface]
PrivateKey = <node-private-key>
Address = <node-wireguard-ip>/16
ListenPort = 51820
```

**Peer entries (repeat for each peer):**

```ini
[Peer]
PublicKey = <peer-public-key>
Endpoint = <peer-public-ip>:51820
AllowedIPs = <peer-wireguard-ip>/32
PersistentKeepalive = 25
```

**Notes:**
- Use **/32 AllowedIPs per peer** to avoid routing the whole mesh through one node.
- NAT masquerade is **not** required for a standard full mesh.
- If a node is behind NAT, keep `PersistentKeepalive` enabled.

## Managing the Mesh

### Enable and Start WireGuard

**On all nodes:**

```bash
# Set proper permissions
sudo chmod 600 /etc/wireguard/wg0.conf

# Enable and start WireGuard
sudo systemctl enable wg-quick@wg0
sudo systemctl start wg-quick@wg0

# Check status
sudo systemctl status wg-quick@wg0
sudo wg show
```

### Manage WireGuard Interface

```bash
# Start interface manually
sudo wg-quick up wg0

# Stop interface  
sudo wg-quick down wg0

# Reload configuration
sudo wg-quick down wg0
sudo wg-quick up wg0

# Show interface status
sudo wg show wg0

# Show detailed peer info
sudo wg show wg0 dump
```

## Name Resolution

Manual mesh deployments should use `/etc/hosts` or internal DNS for backend service names.
Privateer provides local DNS for mesh hostnames (default `:5353`) and publishes service records from Quartermaster.

## Firewall Configuration

### iptables Rules

**Allow WireGuard traffic:**

```bash
# Allow WireGuard port
sudo iptables -A INPUT -p udp --dport 51820 -j ACCEPT

# Allow WireGuard interface traffic
sudo iptables -A INPUT -i wg0 -j ACCEPT
sudo iptables -A FORWARD -i wg0 -j ACCEPT
sudo iptables -A OUTPUT -o wg0 -j ACCEPT

# Save rules (Ubuntu/Debian)
sudo iptables-save > /etc/iptables/rules.v4
```

### UFW Configuration (Ubuntu)

```bash
# Allow WireGuard port
sudo ufw allow 51820/udp

# Allow mesh network traffic
sudo ufw allow from 10.18.0.0/16

# Enable UFW
sudo ufw enable
```

Service ports differ by component. Use the port table in `operators/architecture` and restrict internal services to the mesh CIDR.

## Testing and Validation

### Connectivity Testing

**Test mesh connectivity:**

```bash
# From any node, ping other mesh nodes
ping 10.18.0.1   # Central
ping 10.18.1.21  # Regional EU
ping 10.18.2.11  # YugabyteDB-1
ping 10.18.3.11  # ClickHouse-1

# Test with specific packet sizes
ping -s 1400 10.18.0.1
ping -s 8192 10.18.2.11
```

### Bandwidth Testing

**Install and test bandwidth:**

```bash
# Install iperf3
sudo apt install iperf3

# On target node (server)
iperf3 -s

# From source node (client)
iperf3 -c 10.18.x.x -t 30
```

### Service Testing

**Test database connectivity:**

```bash
# YugabyteDB connection test
telnet 10.18.2.11 5433

# ClickHouse connection test  
telnet 10.18.3.11 9000

# HTTP service test
curl http://10.18.0.1:18001/health
```

### Monitoring Commands

```bash
# WireGuard status
sudo wg show

# Traffic statistics
sudo wg show wg0 transfer

# Peer status
sudo wg show wg0 peers

# Interface statistics
ip -s link show wg0

# Routing table
ip route show table all | grep wg0

# Active connections
ss -tuln | grep :51820
```

## Network Troubleshooting

### Common Issues

**Peers not connecting:**
1. Check public keys match in configuration
2. Verify endpoints are reachable: `ping <public-ip>`
3. Check firewall allows port 51820/udp
4. Verify NAT/port forwarding if behind router

**High latency/packet loss:**
1. Test direct connectivity without WireGuard
2. Check for MTU issues: `ping -s 1472 -M do <target>`
3. Adjust MTU in WireGuard config: `MTU = 1420`
4. Monitor bandwidth utilization

**Services can't reach each other:**
1. Verify WireGuard interface is up: `ip addr show wg0`
2. Check routing table: `ip route show table all`
3. Test mesh connectivity: `ping 10.18.x.x`
4. Verify firewall allows service ports

### Debug Commands

```bash
# Detailed WireGuard info
sudo wg show all dump

# Interface configuration
ip addr show wg0
ip route show dev wg0

# Network troubleshooting
traceroute 10.18.x.x
mtr 10.18.x.x
tcpdump -i wg0

# Log analysis
sudo journalctl -u wg-quick@wg0 -f
sudo tail -f /var/log/syslog | grep -i wireguard
```

### Performance Tuning

**Optimize for throughput:**

```ini
# /etc/sysctl.d/99-wireguard.conf
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
```

**Optimize for low latency:**

```ini
# Reduce keepalive intervals
PersistentKeepalive = 15

# Optional: disable reverse path filtering for wg0 if routing is asymmetric
# /etc/sysctl.d/99-wireguard.conf
net.ipv4.conf.wg0.rp_filter = 0
```

Apply sysctl changes:
```bash
sudo sysctl --system
```

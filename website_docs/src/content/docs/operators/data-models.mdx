---
title: "Data Models"
description: "Dual-database architecture details: PostgreSQL for state and ClickHouse for time-series analytics."
sidebar:
  order: 8
---

import { Aside } from '@astrojs/starlight/components';

<Aside type="caution" title="Self-Hosting Coming Soon">
Self-hosting and hybrid deployment options are currently in development.
This page documents the platform architecture for transparency.
Deployment guides will be available when the feature launches.
</Aside>

FrameWorks utilizes a dual-database architecture to optimize for both transactional integrity and high-volume analytics. This hybrid approach ensures that configuration changes are immediate and reliable (ACID), while millions of data points from the edge are ingested and queried in realtime.

- **PostgreSQL**: Source of truth for entity state, configuration, and billing. Organized into service-specific schemas.
- **ClickHouse**: High-volume time-series analytics and event logs.

---

## PostgreSQL Schemas

### Commodore (Control Plane)
Manages user identities, stream configurations, and API access.

| Table | Purpose |
|-------|---------|
| `users` | User accounts, authentication, and profiles. |
| `sessions` | Web session tokens. |
| `refresh_tokens` | Secure refresh token storage for JWT renewal. |
| `api_tokens` | Developer API tokens. |
| `streams` | Stream configuration, playback IDs, recording settings. |
| `stream_keys` | RTMP ingest keys (supports rotation). |

### Quartermaster (Infrastructure)
Manages multi-tenant infrastructure registry and service orchestration.

| Table | Purpose |
|-------|---------|
| `tenants` | Tenant accounts, limits, and branding configuration. |
| `infrastructure_clusters` | Physical/logical cluster definitions. |
| `infrastructure_nodes` | Edge/central nodes with capacity and health status. |
| `services` | Master catalog of microservices. |
| `service_instances` | Running instances on specific nodes. |
| `cluster_services` | Service deployment specs per cluster. |
| `tenant_cluster_assignments` | Maps tenants to specific clusters. |
| `tenant_cluster_access` | Runtime access control and quota tracking. |
| `bootstrap_tokens` | One-time tokens for edge node enrollment. |
| `node_fingerprints` | Stable identity mapping for nodes. |
| `ansible_groups` | Ansible dynamic inventory group definitions. |
| `node_ansible_group_map` | Computed mapping of nodes to Ansible groups. |

### Purser (Billing)
Manages invoicing, payments, and subscription tiers.

| Table | Purpose |
|-------|---------|
| `billing_invoices` | Generated invoices with line items. |
| `billing_payments` | Payment transactions (Stripe, Crypto, etc.). |
| `billing_tiers` | Service plans (Free, Pro, Enterprise) and limits. |
| `cluster_tier_support` | Cluster-specific tier availability and configuration. |
| `tenant_subscriptions` | Active tenant subscriptions. |
| `usage_records` | Aggregated usage metrics (storage, egress) for billing. |
| `invoice_drafts` | Pre-calculation of upcoming invoices. |
| `crypto_wallets` | Ephemeral wallets for crypto payments. |

### Periscope (Analytics)
Stores billing coordination state.

| Table | Purpose |
|-------|---------|
| `billing_cursors` | Tracks last-processed timestamp for billing summary generation. |

### Foghorn (Media Control)
Manages clip/DVR artifacts and node outputs.

| Table | Purpose |
|-------|---------|
| `clips` | Clip requests and storage tracking. |
| `dvr_requests` | DVR recording requests. |
| `artifact_registry` | Registry of stored artifacts (clips, recordings). |
| `node_outputs` | Cached node output configurations. |
| `node_lifecycle` | Full node lifecycle snapshot storage. |

### Navigator (DNS & Certificates)
Manages DNS automation and SSL certificate issuance.

| Table | Purpose |
|-------|---------|
| `certificates` | SSL/TLS certificate storage. |
| `acme_accounts` | ACME account registration data. |

> **Note**: Real-time stream state (viewers, health) is stored in ClickHouse state tables (`live_streams`, `live_nodes`, `live_artifacts`) using the dual-write pattern, while PostgreSQL holds configuration and billing data.

---

## ClickHouse Tables

ClickHouse stores immutable event logs and materialized views for fast querying.

### State Tables (ReplacingMergeTree)
Current state snapshots, deduplicated by primary key. Query with `FINAL` for latest state.

| Table | Description |
|-------|-------------|
| `live_streams` | Current stream state (status, viewers, health, quality). |
| `live_nodes` | Current node state (CPU, RAM, disk, health). |
| `live_artifacts` | Current clip/DVR job state (stage, progress, output). |
| `viewer_sessions` | Active viewer session tracking. |

### Event Logs (MergeTree)
High-cardinality, append-only tables receiving raw data from Kafka.

| Table | Description |
|-------|-------------|
| `stream_events` | Lifecycle events (start, end, buffer) and push status. |
| `viewer_metrics` | Periodic viewer heartbeats (10-15s intervals). |
| `connection_events` | Viewer connect/disconnect sessions. |
| `client_metrics` | Player-side QoE metrics (bandwidth, errors). |
| `node_metrics` | Infrastructure health (CPU, RAM, Network). |
| `routing_events` | Load balancer decision logs (Foghorn). |
| `stream_health_metrics` | Encoder-level health stats (bitrate, FPS, jitter). |
| `track_list_events` | Track inventory snapshots (audio/video tracks). |
| `track_change_events` | Track list diffs (adaptive bitrate changes). |
| `rebuffering_events` | Derived rebuffer incidents. |
| `clip_events` | Clip/DVR generation lifecycle events. |
| `storage_snapshots` | Storage usage snapshots per tenant/node. |

### Materialized Views (Aggregations)
Background processes that roll up raw data into optimized summaries.

*   **5-Minute Rollups**: `viewer_metrics_5m`, `client_metrics_5m`, `node_performance_5m`, `stream_health_5m`.
*   **Hourly Rollups**: `stream_viewer_hourly`, `stream_connection_hourly`, `viewer_geo_hourly`, `node_metrics_1h`, `quality_changes_1h`, `clip_events_1h`.
*   **Daily Rollups**: `tenant_viewer_daily`, `tenant_connection_daily`, `quality_tier_daily`.

---

## Data Access Patterns

### Pagination
All list endpoints in the Control Plane and Analytics API support pagination using `limit` and `offset` parameters.
*   **Default Limit**: 100
*   **Max Limit**: 1000
*   **Response Headers**: Total count is often returned in the response body metadata.

### Approximate Counts
For high-volume ClickHouse tables (`viewer_metrics`, `stream_events`), total counts are retrieved using optimized approximate counting methods or pre-calculated materializations to ensure sub-100ms response times even with millions of rows.

### Isolation
*   **Tenant ID**: Mandatory filter for all queries. Enforced by middleware.
*   **Service Boundaries**: Services connect only to their own Postgres schema. Cross-service access happens via gRPC/HTTP APIs, never direct DB links.

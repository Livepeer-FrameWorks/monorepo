---
title: "Architecture Overview"
description: "High-level overview of FrameWorks multi-plane architecture, service stack, and data flow."
sidebar:
  order: 1
  label: "Architecture"
---

import { Steps, Card, Aside } from "@astrojs/starlight/components";

<Aside type="note" title="Reality check">
  This page reflects the **current architecture**. Self-hosting and hybrid deployment options are
  available but still evolving; some pieces are production-ready and others are in active
  development.
</Aside>

## Overview

FrameWorks employs a pragmatic, tiered approach to infrastructure management, evolving from simple local setups to complex, distributed production environments.

- **Current (MVP):**
  - **Local Development:** Uses Docker Compose for a self-contained, rapidly reproducible environment.
  - **Deployment:** Relies on the FrameWorks CLI (`frameworks cluster provision`), which orchestrates provisioning via internal provisioners (Ansible is used for some infrastructure components). See [CLI Reference](/operators/cli-reference).
  - **Coordination:** The Quartermaster service acts as the source of truth, exposing tenant and cluster context via its API.

- **Planned Evolution:**
  - **Infrastructure as Code:** Introducing Terraform to manage machine resources (VMs, DNS records, Load Balancers) declaratively.
  - **Orchestration:** Migrating to Kubernetes and GitOps for robust, long-term container orchestration at scale.

## Multi-Plane Architecture

FrameWorks uses a multi-plane distributed architecture designed for scale, separating control logic from high-volume media and event data:

- **Control Plane**: Authentication, stream management, tenant/routing (immediate consistency).
- **Data Plane**: Analytics, metrics, and event processing (Kafka-driven).
- **Media Plane**: Media ingest/processing and routing.
- **Support & Interfaces**: Web apps, marketing sites, and documentation.

![Microservices Architecture](../../../assets/diagrams/Microservices_Architecture.png)

---

## Service Stack

The FrameWorks platform is composed of specialized services, each responsible for a distinct domain. These services communicate primarily via gRPC for internal traffic and expose a unified GraphQL API for external clients.

### Core Services

| Service                  | Port(s)                    | Tier     | Purpose                                                             |
| ------------------------ | -------------------------- | -------- | ------------------------------------------------------------------- |
| **Control Plane**        |                            |          |                                                                     |
| Bridge                   | 18000                      | Regional | GraphQL API Gateway (aggregates all services)                       |
| Commodore                | 18001 (HTTP), 19001 (gRPC) | Central  | Business logic & orchestration API                                  |
| Quartermaster            | 18002 (HTTP), 19002 (gRPC) | Central  | Tenant management API                                               |
| Purser                   | 18003 (HTTP), 19003 (gRPC) | Central  | Billing API                                                         |
| Navigator                | 18010 (HTTP), 18011 (gRPC) | Central  | DNS automation & ACME certificates (Future: Self-hosted Anycast) \* |
| **Data Plane**           |                            |          |                                                                     |
| Periscope Query          | 18004 (HTTP), 19004 (gRPC) | Central  | Analytics & reporting API                                           |
| Periscope Ingest         | 18005                      | Regional | Kafka event processing                                              |
| Decklog                  | 18006 (gRPC)               | Regional | gRPC event ingress → Kafka                                          |
| Decklog (metrics)        | 18026                      | Regional | Prometheus metrics                                                  |
| Signalman                | 18009 (WS), 19005 (gRPC)   | Regional | Real-time updates & WebSocket hub                                   |
| **Media Plane**          |                            |          |                                                                     |
| Foghorn                  | 18008                      | Regional | Load balancer, stream replication orchestrator (HA via Redis)       |
| Foghorn (control)        | 18019 (gRPC)               | Regional | gRPC control API + FoghornFederation (cross-cluster peering)        |
| Helmsman                 | 18007 (HTTP)               | Edge     | MistServer sidecar                                                  |
| **Support & Interfaces** |                            |          |                                                                     |
| Deckhand                 | 18015 (HTTP), 19006 (gRPC) | Central  | Support messaging API (Chatwoot adapter)                            |
| Web Console              | 18030                      | Central  | Main application interface                                          |
| Marketing Site           | 18031                      | Central  | Public website                                                      |
| Forms                    | 18032                      | Central  | Contact form handling                                               |

### Infrastructure Components

| Component                                    | Role                                | Plane          | Port(s)                                            | Deploy Location                            |
| -------------------------------------------- | ----------------------------------- | -------------- | -------------------------------------------------- | ------------------------------------------ |
| MistServer                                   | Media processing (ingest/transcode) | Media          | 4242, 8080, 1935, 5554, 4200, 8889/udp, 18203/udp  | Edge                                       |
| Livepeer Gateway (external)                  | Operator-hosted transcoding gateway | Media          | Operator-defined                                   | Operator-managed                           |
| PostgreSQL-compatible DB (Postgres/Yugabyte) | State & configuration database      | Control        | Operator-defined                                   | Central                                    |
| ClickHouse                                   | Time-series analytics database      | Data           | 8123 (HTTP), 9000 (Native)                         | Central                                    |
| Kafka                                        | Event streaming backbone            | Data           | 9092 (Int), 29092 (Ext)                            | Central + Regional (single shared cluster) |
| Zookeeper                                    | Kafka cluster management            | Data           | 2181                                               | Central + Regional                         |
| Privateer                                    | WireGuard mesh agent                | Infrastructure | 18012 (API), 5353/udp (DNS), 51820/udp (WireGuard) | Central/Regional \*                        |
| Nginx                                        | Reverse proxy & routing             | Support        | 18090                                              | Central                                    |
| VictoriaMetrics (or Prometheus)              | Metrics collection                  | Support        | Operator-defined                                   | Central                                    |
| Grafana                                      | Metrics visualization               | Support        | Operator-defined                                   | Central                                    |
| Listmonk                                     | Newsletter/mailing list manager     | Support        | 9000 (service), 9001 (docker-compose host)         | Central                                    |

| Foghorn Redis | 6379 | Foghorn state sync (HA) | Infrastructure | Regional |

_Navigator and Privateer are in testing. Production rollout is controlled and may not be enabled in every environment._

**Livepeer integration note**: Today you run the Livepeer Gateway as an external service and configure MistServer to send segments to it. Longer term, we will integrate more directly with Livepeer orchestrators or embed the gateway more tightly.

### Interfaces

| Component      | Role                         | Path                  | Port              | Deploy Location |
| -------------- | ---------------------------- | --------------------- | ----------------- | --------------- |
| Web Console    | SvelteKit user dashboard     | `website_application` | 18030             | Regional        |
| Marketing Site | Sales / Marketing website    | `website_marketing`   | 18031             | Regional        |
| Documentation  | Astro Starlight docs site    | `website_docs`        | 18033             | Central         |
| NPM Player     | Embeddable HLS/WebRTC player | `npm_player`          | N/A (npm package) | User websites   |
| Android App    | Future mobile client         | `app_android`         | N/A               | Planned         |

_Note: The Android App is currently a stub and represents a planned future interface for streaming to and consuming from the FrameWorks network._

### CLI Tool

| Component      | Role                                | Path   | Install                |
| -------------- | ----------------------------------- | ------ | ---------------------- |
| FrameWorks CLI | Cluster management and provisioning | `cli/` | `go install` or binary |

---

## Planned Services (Not Implemented)

| Service                   | Purpose                  | Status                            |
| ------------------------- | ------------------------ | --------------------------------- |
| Lookout (`api_incidents`) | Incident management      | Deferred (use Prometheus/Grafana) |
| Parlor (`api_rooms`)      | Interactive room service | Planned                           |

---

## Deployment Tiers

- **Central**: Commodore, Quartermaster, Purser, Periscope Query, Deckhand, Forms, PostgreSQL-compatible DB (YugabyteDB recommended), ClickHouse, Listmonk, Chatwoot + Redis.
- **Regional**: Bridge, Foghorn, Decklog, Periscope Ingest, Signalman, Kafka, Web Console, Marketing Site.
- **Central/Regional**: Privateer (WireGuard mesh agent runs on all backend infrastructure nodes).
- **Edge**: MistServer, Helmsman, Livepeer Gateway.

---

## Multi-Cluster Topology

FrameWorks supports multiple clusters. A **cluster** is a Foghorn instance (or HA pair) plus its edge nodes — strictly the media plane. All clusters share the same central control plane (Commodore, Quartermaster, Purser) and data plane (Decklog, Periscope, Signalman). These services are not duplicated or federated per cluster.

Cross-cluster coordination is handled exclusively by the **FoghornFederation** gRPC protocol between Foghorn instances:

- **Peer discovery**: Quartermaster maintains a registry of all clusters. Foghorn queries `ListPeers` to find peers and opens `PeerChannel` bidirectional streams for real-time edge telemetry exchange.
- **Cross-cluster viewer routing**: When a viewer's cluster doesn't have a stream, Foghorn uses `QueryStream` to find it on a peer, then either redirects the viewer or arranges a DTSC origin-pull to serve locally.
- **Cross-cluster artifacts**: VOD clips and DVR recordings on remote clusters are accessed via `PrepareArtifact` (presigned S3 URLs).
- **Leader-only peering**: Each cluster elects one Foghorn instance (via Redis SET NX) to run PeerChannel connections, avoiding duplicate peer traffic.

Quartermaster is the sole routing authority. Commodore resolves tenant-to-cluster routing dynamically via `GetClusterRouting` — no hardcoded Foghorn addresses between services.

**Deployment models:**

| Model                | Description                                                                                                                                                                                                                |
| -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Shared**           | Free rate-limited tier or premium shared tiers. All tenants share the same cluster, edges, and services.                                                                                                                   |
| **Dedicated**        | Enterprise tier. Isolated cluster with dedicated Foghorn, edges, and capacity — operated by FrameWorks or self-hosted on-premise via [CLI](/operators/cli-reference) or [Manual Deployment](/operators/deployment-manual). |
| **Hybrid**           | Tenant runs self-hosted edges that fall back to the primary shared cluster. Edges federate via Foghorn; control/data plane remains shared.                                                                                 |
| **Open Marketplace** | Third-party operators publish clusters with pricing and access controls. Tenants subscribe to clusters via the marketplace. _(In progress)_                                                                                |

---

## Data Flow Architecture

Understanding how data moves through the system is critical for operations and troubleshooting. The diagrams below illustrate the key pipelines for analytics, control, and media.

### Event-Driven Analytics Pipeline

```mermaid
graph LR
    MS[MistServer] --> H[Helmsman]
    H <-->|gRPC| F[Foghorn]
    F --> D[Decklog]
    F -->|gRPC| C[Commodore<br/>validation]
    D --> K[Kafka]
    K --> PI[Periscope-Ingest]
    K --> S[Signalman]
    PI --> CH[(ClickHouse)]
    S --> FE[Frontend<br/>WebSocket]
```

**Note:** Helmsman maintains a persistent **bidirectional** gRPC stream with Foghorn:

- **Helmsman → Foghorn**: MistServer triggers, heartbeats, clip/DVR progress updates
- **Foghorn → Helmsman**: Clip pull requests, DVR start/stop commands, config seeds

Foghorn routes events to central services (Commodore for validation, Decklog for analytics, Quartermaster for tenant resolution).

### Control Plane Communications

```mermaid
graph LR
    FE[Frontend] --> B[Bridge]
    B -->|gRPC| COM[Commodore]
    B -->|gRPC| PUR[Purser<br/>billing]
    B -->|gRPC| QM[Quartermaster<br/>tenant info]
    B -->|gRPC| PER[Periscope Query<br/>analytics]

    H[Helmsman] <-->|gRPC| F[Foghorn]
    F -->|gRPC| COM2[Commodore<br/>validation]
    F -->|gRPC| QM2[Quartermaster<br/>enrollment]
```

### Media Pipeline

```mermaid
graph LR
    IN[RTMP/SRT/WHIP] --> MS[MistServer]
    MS <--> LP[Livepeer<br/>transcoding/AI]
    MS --> OUT[HLS/WebRTC/SRT]
    OUT --> V[Viewers]
    MS --> H[Helmsman]
    H --> F[Foghorn]
```

### Viewer Routing

Foghorn selects optimal edge nodes for viewers based on geography, load, and stream availability.

**Routing Paths:**

```mermaid
graph LR
    P[Player] -->|GraphQL| B[Bridge]
    B -->|gRPC| C[Commodore]
    C -->|gRPC| F[Foghorn]
    F -->|node list| C
    C --> B --> P
    P -->|connect| E[Edge Node]
```

| Path                  | Flow                                  | Use Case                                    |
| --------------------- | ------------------------------------- | ------------------------------------------- |
| **GraphQL (primary)** | Player → Bridge → Commodore → Foghorn | FrameWorks Player, SDK integrations         |
| **HTTP (direct)**     | Client → Foghorn `/play/{viewkey}`    | CLI tools, direct URL access, 307 redirects |

**Foghorn HTTP Endpoints:**

| Endpoint                             | Response                | Use Case                 |
| ------------------------------------ | ----------------------- | ------------------------ |
| `GET /play/{viewkey}`                | JSON with all endpoints | Direct integration       |
| `GET /play/{viewkey}/hls/index.m3u8` | 307 redirect to edge    | Direct HLS playback      |
| `GET /play/{viewkey}/webrtc`         | 307 redirect to edge    | Direct WebRTC (WHEP)     |
| `GET /{viewkey}`                     | Best node host or 307   | MistServer compatibility |

For URI patterns and player integration, see [Playback & Embedding](/streamers/playback).

---

## Infrastructure Layers

```mermaid
graph TB
    subgraph "Infrastructure Layers"
        PROV["Provisioning Layer (IaaS)<br/>Terraform - Planned"]
        CONFIG["Configuration Layer (CaC)<br/>Ansible via CLI"]
        ORCH["Orchestration Layer<br/>Quartermaster"]
    end

    subgraph "Components"
        VMS["Virtual Machines"]
        DNS["DNS/Cloudflare"]
        CERTS["TLS Certificates"]
        MESH["WireGuard Mesh"]
        SERVICES["FrameWorks Services"]
        TENANTS["Tenant Management"]
    end

    PROV --> VMS
    PROV --> DNS
    PROV --> CERTS

    CONFIG --> MESH
    CONFIG --> SERVICES

    ORCH --> TENANTS
    ORCH --> CONFIG
```

---

## Proxy & SSL Strategy

Traffic routing and TLS termination vary by deployment tier:

- **Development:** Nginx (via Docker Compose) handles local routing with self-signed or no TLS.
- **Production (Edge):** Caddy handles automatic HTTPS via Let's Encrypt (HTTP-01 validation).
  - Managed via CLI templates (`cli/internal/templates/edge/Caddyfile.tmpl`).
  - Supports HTTP/2, HTTP/3, and WebSocket upgrades natively.
- **Production (Central/Regional):** Navigator manages public DNS via Cloudflare API.
  - Single node → A record pointing directly to service
  - Multiple nodes → Cloudflare load balancer pool with geo-steering
  - Certificates issued via Let's Encrypt (DNS-01 validation through Cloudflare)

> **Note:** Cloudflare is used for DNS management and geographic load balancing (DNS-only mode, not proxied). Traffic flows directly to FrameWorks services. A self-hosted anycast DNS solution is planned to replace Cloudflare dependency once an ASN is acquired.

---

## Mesh Networking

Internal communication between nodes uses a WireGuard mesh managed by the **Privateer** agent (`api_mesh`). This handles:

- Secure inter-node communication
- Internal DNS resolution
- Backend infrastructure isolation

See [WireGuard Mesh Setup](/operators/wireguard) for configuration details.

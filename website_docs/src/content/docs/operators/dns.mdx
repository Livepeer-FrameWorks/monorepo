---
title: "DNS Automation"
description: "Automated DNS management and certificate issuance with Navigator."
sidebar:
  order: 10
---

import { Aside } from "@astrojs/starlight/components";

Navigator automates DNS record management and certificate issuance for your infrastructure.

---

## DNS Architecture

FrameWorks uses a two-layer routing strategy:

- **DNS layer (Cloudflare)**: Infrastructure-level geo-routing to nearest region
- **Application layer (Foghorn)**: Capacity-aware routing to optimal edge node

> **Note**: Cloudflare is the current DNS provider for convenience, but Navigator is designed to move to a fully self-hosted Anycast DNS layer in the future.

### How Navigator Works

Navigator (`api_dns`) automatically manages Cloudflare DNS based on node inventory from Quartermaster:

1. Quartermaster triggers a DNS sync (for example, when nodes are created/registered)
2. Navigator fetches nodes for that service type and filters to those with external IPs
3. Updates Cloudflare DNS:
   - Single node → A record
   - Multiple nodes → Load balancer pool with geo-steering
4. Applies proxying rules (default: app, website, docs)
5. Handles ACME certificate issuance via DNS-01 challenges

If no nodes are returned for a service type, Navigator skips changes to avoid removing working DNS during a transient outage.

### Verifying DNS State

Use the CLI to verify public DNS matches your inventory:

```bash
frameworks dns doctor --domain yourdomain.com
```

This checks:

- Each subdomain resolves to expected IPs from inventory
- Reports mismatches between public DNS and Quartermaster

By default, the CLI assumes `frameworks.network` if `--domain` is not provided.

---

## Recommended DNS Structure

### Public Endpoints (GeoDNS)

| Subdomain                 | Purpose          | Service            |
| ------------------------- | ---------------- | ------------------ |
| `example.com`             | Marketing site   | Foredeck (Website) |
| `chartroom.example.com`   | Web console      | Chartroom          |
| `bridge.example.com`      | GraphQL API      | Bridge             |
| `foghorn.example.com`     | Viewer routing   | Foghorn            |
| `edge-ingest.example.com` | Stream ingest    | Edge nodes         |
| `edge.example.com`        | Edge pool domain | Edge nodes         |
| `logbook.example.com`     | Docs site        | Logbook            |
| `steward.example.com`     | Forms API        | Steward            |

Navigator only manages subdomains for service types that exist in Quartermaster inventory. Granular subdomains like `edge-egress` and `edge-ingest` are only created when the cluster has a wildcard TLS certificate; otherwise all edge traffic routes through the `edge` pool.

### Internal Services (Private Network / Mesh)

These services communicate over the private network or WireGuard mesh (Privateer) and do **not** need public DNS.
Edge nodes do **not** join the mesh.

- Commodore, Purser, Periscope, Quartermaster, Signalman
- PostgreSQL, ClickHouse, Kafka, Zookeeper

Configure via environment variables with private/mesh IPs:

```bash
export COMMODORE_URL=http://10.0.1.10:18001
export PURSER_URL=http://10.0.1.11:18003
```

### Per-Edge A Records

Navigator creates individual A records for each edge node, enabling direct node addressing:

```
edge-{node_id}.{cluster_slug}.{base_domain}  →  A  →  {node_external_ip}
```

For example, with cluster slug `production` and base domain `frameworks.network`:

| Record                                      | IP              |
| ------------------------------------------- | --------------- |
| `edge-nyc-01.production.frameworks.network` | `203.0.113.10`  |
| `edge-ams-01.production.frameworks.network` | `198.51.100.20` |

Navigator sanitizes the node ID into a DNS-safe label. Nodes without an external IP are skipped.

### Cluster-Scoped DNS

In multi-cluster deployments, each cluster gets its own set of service subdomains under `{cluster_slug}.{base_domain}`:

| Pattern                     | Purpose                                       |
| --------------------------- | --------------------------------------------- |
| `edge-ingest.{slug}.{base}` | RTMP/SRT/WHIP ingest for this cluster's edges |
| `edge.{slug}.{base}`        | Edge pool domain (any edge in cluster)        |
| `foghorn.{slug}.{base}`     | Viewer routing / playback resolution          |
| `bridge.{slug}.{base}`      | GraphQL API                                   |

Navigator applies smart record logic per subdomain: 0 nodes → records deleted, 1 node → A record, 2+ nodes → load balancer pool with geo-steering.

### Wildcard TLS Certificates

Each cluster uses a wildcard certificate for its subdomain space:

```
*.{cluster_slug}.{base_domain}
```

Certificates are issued via ACME DNS-01 challenges through Cloudflare. Navigator manages issuance and renewal.

Once issued, certificates are distributed to edge nodes via **ConfigSeed** — Foghorn pushes TLS bundles to Helmsman over the existing gRPC control stream. Edges do not need direct access to the ACME provider.

### Tenant Subdomains

Tenant-specific subdomains CNAME to the shared infrastructure:

```
tenant1.example.com         → CNAME → foghorn.example.com (or edge.example.com)
tenant1.edge-ingest.example.com  → CNAME → edge-ingest.example.com
```

---

## Cloudflare Configuration

Navigator requires a Cloudflare API token with these permissions:

- **Zone.DNS**: Edit
- **Account.Load Balancers**: Edit (for multi-node setups)

Environment variables for Navigator:

```bash
CLOUDFLARE_API_TOKEN="your-api-token"
CLOUDFLARE_ZONE_ID="your-zone-id"
CLOUDFLARE_ACCOUNT_ID="your-account-id"
```

Optional environment variables:

```bash
# Cloudflare proxy defaults (comma-separated service types)
NAVIGATOR_PROXY_SERVICES="app,website,docs"

# Certificate issuance
ACME_ENV="production"              # or "staging"
NAVIGATOR_CERT_ALLOWED_SUFFIXES="example.com"
```

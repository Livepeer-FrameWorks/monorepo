# GraphQL schema location (shared schema)
schema:
  - ../pkg/graphql/schema.graphql

# Where should the generated server code go?
exec:
  filename: graph/generated/generated.go
  package: generated

# Where should any generated models go?
model:
  filename: graph/model/models_gen.go
  package: model

# Where should the resolver implementations go?
resolver:
  layout: follow-schema
  dir: graph
  package: graph
  filename_template: "{name}.resolvers.go"

# Optional: turn on or off automatic camelCase marshaling for field names
autobind:
  - frameworks/pkg/proto

# Map GraphQL types to existing Go models (comprehensive mapping)
# NOTE: Using pb.* proto types for all analytics/streaming types
models:
  # Analytics root types - custom empty structs (force resolvers)
  Analytics:
    model:
      - frameworks/api_gateway/graph/markers.Analytics
  AnalyticsUsage:
    model:
      - frameworks/api_gateway/graph/markers.AnalyticsUsage
  StreamingUsage:
    model:
      - frameworks/api_gateway/graph/markers.StreamingUsage
  StorageUsage:
    model:
      - frameworks/api_gateway/graph/markers.StorageUsage
  ProcessingUsage:
    model:
      - frameworks/api_gateway/graph/markers.ProcessingUsage
  APIUsage:
    model:
      - frameworks/api_gateway/graph/markers.APIUsage
  AnalyticsHealth:
    model:
      - frameworks/api_gateway/graph/markers.AnalyticsHealth
  AnalyticsLifecycle:
    model:
      - frameworks/api_gateway/graph/markers.AnalyticsLifecycle
  AnalyticsInfra:
    model:
      - frameworks/api_gateway/graph/markers.AnalyticsInfra
  TenantEvent:
    model:
      - frameworks/api_gateway/graph/model.TenantEvent
  SkipperInvestigationEvent:
    model:
      - frameworks/api_gateway/graph/model.SkipperInvestigationEvent
  # Rollup analytics types - use generated model types (NOT proto)
  # Proto has same-named types (StreamHealthSummary, ClientQoeSummary, RoutingCountryStat)
  # but resolvers return model.* types, so we must override autobind.
  StreamHealthSummary:
    model:
      - frameworks/api_gateway/graph/model.StreamHealthSummary
  ClientQoeSummary:
    model:
      - frameworks/api_gateway/graph/model.ClientQoeSummary
  RoutingEfficiency:
    model:
      - frameworks/api_gateway/graph/model.RoutingEfficiency
  RoutingCountryStat:
    model:
      - frameworks/api_gateway/graph/model.RoutingCountryStat

  # Analytics types - bound to proto types
  StreamAnalyticsSummary:
    model:
      - frameworks/pkg/proto.StreamAnalyticsSummary
    fields:
      streamId:
        resolver: true
      stream:
        resolver: true
  QualityTierSummary:
    model:
      - frameworks/pkg/proto.QualityTierSummary
  RoutingEvent:
    model:
      - frameworks/pkg/proto.RoutingEvent
    fields:
      streamId:
        resolver: true
      stream:
        resolver: true
  ViewerSession:
    model:
      - frameworks/pkg/proto.ViewerSession
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  ViewerMetrics5m:
    model:
      - frameworks/pkg/proto.ViewerSession5M
  ConnectionEvent:
    model:
      - frameworks/pkg/proto.ConnectionEvent
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      connectionAddr:
        resolver: true # Redact client IP for privacy
      stream:
        resolver: true
  StreamHealthMetric:
    model:
      - frameworks/pkg/proto.StreamHealthMetric
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  ViewerCountBucket:
    model:
      - frameworks/pkg/proto.ViewerCountBucket
    fields:
      streamId:
        resolver: true
      stream:
        resolver: true
  GeographicDistribution:
    model:
      - frameworks/api_gateway/graph/model.GeographicDistribution
    fields:
      streamId:
        resolver: true
      stream:
        resolver: true
  RebufferingEvent:
    model:
      - frameworks/pkg/proto.RebufferingEvent
    fields:
      streamId:
        resolver: true
      stream:
        resolver: true
  CountryMetric:
    model:
      - frameworks/pkg/proto.CountryMetric
  CountryMetrics:
    model:
      - frameworks/pkg/proto.CountryMetrics
  CityMetric:
    model:
      - frameworks/pkg/proto.CityMetric
  PlatformOverview:
    model:
      - frameworks/pkg/proto.GetPlatformOverviewResponse
  ViewerGeographic:
    model:
      - frameworks/pkg/proto.ConnectionEvent
    fields:
      streamId:
        resolver: true
      connectionAddr:
        resolver: true # Redact client IP for privacy
      stream:
        resolver: true
  StreamEvent:
    model:
      - frameworks/api_gateway/graph/model.StreamEvent
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      payload:
        resolver: true
      stream:
        resolver: true
  BufferEvent:
    model:
      - frameworks/pkg/proto.BufferEvent
    fields:
      id:
        resolver: true
      timestamp:
        resolver: true
      bufferState:
        resolver: true
      payload:
        resolver: true
  # Query types - bound to periscope.proto types (analytics API responses)
  TrackListEvent:
    model:
      - frameworks/pkg/proto.TrackListEvent
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  ArtifactEvent:
    model:
      - frameworks/pkg/proto.ClipEvent
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      playbackId:
        resolver: true
      filePath:
        resolver: true
      s3Url:
        resolver: true
      stream:
        resolver: true
  ArtifactState:
    model:
      - frameworks/pkg/proto.ArtifactState
    fields:
      streamId:
        resolver: true
      playbackId:
        resolver: true
      filePath:
        resolver: true
      s3Url:
        resolver: true
      manifestPath:
        resolver: true
      stream:
        resolver: true
  StreamTrack:
    model:
      - frameworks/pkg/proto.StreamTrack
  # Pre-aggregated analytics types (Materialized Views)
  StreamConnectionHourly:
    model:
      - frameworks/pkg/proto.StreamConnectionHourly
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  ClientMetrics5m:
    model:
      - frameworks/pkg/proto.ClientMetrics5M
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  QualityTierDaily:
    model:
      - frameworks/pkg/proto.QualityTierDaily
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  QualityChangesHourly:
    model:
      - frameworks/pkg/proto.QualityChangesHourly
  StorageUsageRecord:
    model:
      - frameworks/pkg/proto.StorageUsageRecord
    fields:
      id:
        resolver: true
  StorageEvent:
    model:
      - frameworks/pkg/proto.StorageEvent
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  StorageSnapshot:
    model:
      - frameworks/pkg/proto.StorageSnapshot
  TenantStorageUsage:
    model:
      - frameworks/pkg/proto.TenantStorageUsage
  StreamHealth5m:
    model:
      - frameworks/pkg/proto.StreamHealth5M
    fields:
      id:
        resolver: true
  NodePerformance5m:
    model:
      - frameworks/pkg/proto.NodePerformance5M
    fields:
      id:
        resolver: true
  ViewerHoursHourly:
    model:
      - frameworks/pkg/proto.ViewerHoursHourly
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  ViewerGeoHourly:
    model:
      - frameworks/pkg/proto.ViewerGeoHourly
    fields:
      id:
        resolver: true
  TenantDailyStat:
    model:
      - frameworks/pkg/proto.TenantDailyStat
    fields:
      id:
        resolver: true
  StreamAnalyticsDaily:
    model:
      - frameworks/pkg/proto.StreamAnalyticsDaily
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  ProcessingUsageRecord:
    model:
      - frameworks/pkg/proto.ProcessingUsageRecord
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  APIUsageRecord:
    model:
      - frameworks/pkg/proto.APIUsageRecord
    fields:
      id:
        resolver: true
      timestamp:
        resolver: true
      requestCount:
        resolver: true
      errorCount:
        resolver: true
      totalDurationMs:
        resolver: true
      totalComplexity:
        resolver: true
      uniqueUsers:
        resolver: true
      uniqueTokens:
        resolver: true
  APIUsageSummary:
    model:
      - frameworks/pkg/proto.APIUsageSummary
    fields:
      date:
        resolver: true
      totalRequests:
        resolver: true
      totalErrors:
        resolver: true
      totalComplexity:
        resolver: true
      uniqueUsers:
        resolver: true
      uniqueTokens:
        resolver: true
  APIUsageOperationSummary:
    model:
      - frameworks/pkg/proto.APIUsageOperationSummary
    fields:
      totalRequests:
        resolver: true
      totalErrors:
        resolver: true
      uniqueOperations:
        resolver: true
      totalComplexity:
        resolver: true

  # Real-time subscription types - bound to ipc.proto types (raw Kafka events via Signalman)
  ViewerMetrics:
    model:
      - frameworks/pkg/proto.ClientLifecycleUpdate
    fields:
      streamId:
        resolver: true
      host:
        resolver: true # Redact client IP for privacy
      stream:
        resolver: true
  SystemHealthEvent:
    model:
      - frameworks/pkg/proto.NodeLifecycleUpdate
    fields:
      nodeId:
        resolver: true # Return node_uuid (database UUID) not node_id (logical name)
  DVREvent:
    model:
      - frameworks/pkg/proto.DVRLifecycleData
    fields:
      playbackId:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
  TrackListUpdate:
    model:
      - frameworks/pkg/proto.StreamTrackListTrigger
    fields:
      streamId:
        resolver: true
      stream:
        resolver: true
  ClipLifecycle:
    model:
      - frameworks/pkg/proto.ClipLifecycleData
    fields:
      playbackId:
        resolver: true
      streamId:
        resolver: true
      stream:
        resolver: true
      filePath:
        resolver: true
      s3Url:
        resolver: true

  # Real-time stream subscription types - direct proto passthrough
  VodLifecycle:
    model:
      - frameworks/pkg/proto.VodLifecycleData
    fields:
      playbackId:
        resolver: true
      # Security: Don't expose internal identifiers
      tenantId:
        resolver: true # Return nil - internal only
      userId:
        resolver: true # Return nil - internal only
      filePath:
        resolver: true
      s3Url:
        resolver: true

  # Stream management types - bound to proto types
  Stream:
    model:
      - frameworks/pkg/proto.Stream
  StreamMetrics:
    model:
      - frameworks/pkg/proto.StreamStatusResponse
  StreamKey:
    model:
      - frameworks/pkg/proto.StreamKey
    fields:
      streamId:
        resolver: true
      stream:
        resolver: true
  Recording:
    model:
      - frameworks/pkg/proto.Recording
  Clip:
    model:
      - frameworks/pkg/proto.ClipInfo
    fields:
      id:
        resolver: true
      streamId:
        resolver: true
      # Lifecycle fields resolved from Periscope (batch lookup by clipHash)
      status:
        resolver: true
      sizeBytes:
        resolver: true
      storageLocation:
        resolver: true
      nodeId:
        resolver: true
      storagePath:
        resolver: true
      stream:
        resolver: true
  DVRRequest:
    model:
      - frameworks/pkg/proto.DVRInfo
    fields:
      streamId:
        resolver: true
      # Lifecycle fields resolved from Periscope (batch lookup by dvrHash)
      status:
        resolver: true
      sizeBytes:
        resolver: true
      storageLocation:
        resolver: true
      storageNodeId:
        resolver: true
      manifestPath:
        resolver: true
      startedAt:
        resolver: true
      endedAt:
        resolver: true
      durationSeconds:
        resolver: true
      errorMessage:
        resolver: true
      s3Url:
        resolver: true
      frozenAt:
        resolver: true

      # VOD upload types - generated by gqlgen (not bound to proto)
      # Because VodAsset/VodUploadSession are used in unions, they need marker interface methods
      # which proto types don't have. Let gqlgen generate them and convert in resolvers.

      # Viewer endpoint resolution types - bound to proto types
      stream:
        resolver: true
  ViewerEndpointResponse:
    model:
      - frameworks/pkg/proto.ViewerEndpointResponse
  ViewerEndpoint:
    model:
      - frameworks/pkg/proto.ViewerEndpoint
  PlaybackMetadata:
    model:
      - frameworks/pkg/proto.PlaybackMetadata
  PlaybackTrack:
    model:
      - frameworks/pkg/proto.PlaybackTrack
  PlaybackInstance:
    model:
      - frameworks/pkg/proto.PlaybackInstance
  IngestMetadata:
    model:
      - frameworks/pkg/proto.IngestMetadata
    fields:
      streamId:
        resolver: true

      # Billing types - bound to proto types
      stream:
        resolver: true
  BillingStatus:
    model:
      - frameworks/pkg/proto.BillingStatusResponse
  BillingTier:
    model:
      - frameworks/pkg/proto.BillingTier
  BillingFeatures:
    model:
      - frameworks/pkg/proto.BillingFeatures
  AllocationDetails:
    model:
      - frameworks/pkg/proto.AllocationDetails
  OverageRates:
    model:
      - frameworks/pkg/proto.OverageRates
  Invoice:
    model:
      - frameworks/pkg/proto.Invoice
  Payment:
    model:
      - frameworks/pkg/proto.PaymentResponse
  UsageRecord:
    model:
      - frameworks/pkg/proto.UsageRecord
  UsageSummary:
    model:
      - frameworks/pkg/proto.UsageSummary
  LiveUsageSummary:
    model:
      - frameworks/pkg/proto.LiveUsageSummary
  # TenantUsage, UsageEntry, CostEntry remain as model types
  # because proto.TenantUsageResponse uses map<string, double>
  # which doesn't map directly to GraphQL arrays

  # Infrastructure types - bound to proto types
  ServiceInstance:
    model:
      - frameworks/pkg/proto.ServiceInstance
  ServiceInstanceHealth:
    model:
      - frameworks/pkg/proto.ServiceInstanceHealth
    fields:
      host:
        resolver: true
      healthEndpoint:
        resolver: true
  NodeMetric:
    model:
      - frameworks/pkg/proto.NodeMetric
    fields:
      id:
        resolver: true
  NodeMetricHourly:
    model:
      - frameworks/pkg/proto.NodeMetricHourly
    fields:
      id:
        resolver: true
  NodeMetricsAggregated:
    model:
      - frameworks/pkg/proto.NodeMetricsAggregated
  TimeRange:
    model:
      - frameworks/pkg/proto.TimeRange
  Cluster:
    model:
      - frameworks/pkg/proto.InfrastructureCluster
    fields:
      id:
        resolver: true
  Node:
    model:
      - frameworks/api_gateway/graph/model.Node
  InfrastructureNode:
    model:
      - frameworks/pkg/proto.InfrastructureNode
    fields:
      id:
        resolver: true
      internalIp:
        resolver: true
      externalIp:
        resolver: true
      wireguardIp:
        resolver: true
      wireguardPublicKey:
        resolver: true

  # Cluster Marketplace types - bound to proto types
  MarketplaceCluster:
    model:
      - frameworks/pkg/proto.MarketplaceClusterEntry
  ClusterSubscription:
    model:
      - frameworks/pkg/proto.ClusterSubscription
  ClusterInvite:
    model:
      - frameworks/pkg/proto.ClusterInvite

  # Tenant types - bound to proto types
  Tenant:
    model:
      - frameworks/pkg/proto.Tenant
  User:
    model:
      - frameworks/pkg/proto.User
  # WalletIdentity and WalletLoginPayload: NOT bound to proto.
  # Because they're used in union types which require marker interface methods.
  # Use manually created model types (graph/model/wallet.go).
  WalletIdentity:
    model:
      - frameworks/api_gateway/graph/model.WalletIdentity
  WalletLoginPayload:
    model:
      - frameworks/api_gateway/graph/model.WalletLoginPayload
  # BalanceTransaction and PrepaidBalance: NOT bound to proto.
  # Use manually created model types (graph/model/prepaid.go).
  BalanceTransaction:
    model:
      - frameworks/api_gateway/graph/model.BalanceTransaction
  PrepaidBalance:
    model:
      - frameworks/api_gateway/graph/model.PrepaidBalance
  DeveloperToken:
    model:
      - frameworks/pkg/proto.APITokenInfo
  BootstrapToken:
    model:
      - frameworks/pkg/proto.BootstrapToken

  Money:
    model:
      - github.com/99designs/gqlgen/graphql.Float
  Currency:
    model:
      - github.com/99designs/gqlgen/graphql.String

  # Analytics sort enums - bound to proto types
  SortOrder:
    model:
      - frameworks/pkg/proto.SortOrder
  StreamSummarySortField:
    model:
      - frameworks/pkg/proto.StreamSummarySortField

  # Cluster marketplace enums - bound to proto types
  ClusterVisibility:
    model:
      - frameworks/pkg/proto.ClusterVisibility
  ClusterPricingModel:
    model:
      - frameworks/pkg/proto.ClusterPricingModel
  ClusterSubscriptionStatus:
    model:
      - frameworks/pkg/proto.ClusterSubscriptionStatus

  # Crypto top-up enums - bound to proto types
  CryptoAsset:
    model:
      - frameworks/pkg/proto.CryptoAsset

  # AI Consultant (Skipper) types - manual model types (union members need marker interfaces)
  SkipperChatEvent:
    model:
      - frameworks/api_gateway/graph/model.SkipperChatEvent
  SkipperToken:
    model:
      - frameworks/api_gateway/graph/model.SkipperToken
  SkipperToolStartEvent:
    model:
      - frameworks/api_gateway/graph/model.SkipperToolStartEvent
  SkipperToolEndEvent:
    model:
      - frameworks/api_gateway/graph/model.SkipperToolEndEvent
  SkipperMeta:
    model:
      - frameworks/api_gateway/graph/model.SkipperMeta
  SkipperCitation:
    model:
      - frameworks/api_gateway/graph/model.SkipperCitation
  SkipperToolDetail:
    model:
      - frameworks/api_gateway/graph/model.SkipperToolDet
  SkipperDone:
    model:
      - frameworks/api_gateway/graph/model.SkipperDone
  SkipperConversation:
    model:
      - frameworks/api_gateway/graph/model.SkipperConversation
  SkipperConversationSummary:
    model:
      - frameworks/api_gateway/graph/model.SkipperConversationSummary
  SkipperMessage:
    model:
      - frameworks/api_gateway/graph/model.SkipperMessage
  SkipperChatInput:
    model:
      - frameworks/api_gateway/graph/model.SkipperChatInput
  SkipperMode:
    model:
      - frameworks/api_gateway/graph/model.SkipperMode

  # Support messaging enums - bound to proto types
  ConversationStatus:
    model:
      - frameworks/pkg/proto.ConversationStatus
  MessageSender:
    model:
      - frameworks/pkg/proto.MessageSender

# Skip generation for these types (we'll implement them manually)
skip_validation: true

name: CI

on:
  pull_request:
    branches: [development, main]
  push:
    branches: [development]

jobs:
  go:
    name: Go tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - name: Install protoc Go plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@v1.36.11
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@v1.6.0
      - name: Install gqlgen
        run: go install github.com/99designs/gqlgen@v0.17.78
      - run: make build
      - run: make test

  go-lint:
    name: Go lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Full history needed for --new-from-rev
      - uses: actions/setup-go@v5
        with:
          go-version: "1.24"
      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.0
      - name: Read baseline commit
        id: baseline
        run: |
          if [ -f .golangci-baseline ]; then
            echo "rev=$(cat .golangci-baseline)" >> $GITHUB_OUTPUT
            echo "Using baseline: $(cat .golangci-baseline)"
          else
            echo "rev=" >> $GITHUB_OUTPUT
            echo "No baseline file found, checking all code"
          fi
      - name: Run golangci-lint on all modules
        run: |
          BASELINE="${{ steps.baseline.outputs.rev }}"
          BASELINE_ARG=""
          if [ -n "$BASELINE" ]; then
            BASELINE_ARG="--new-from-rev=$BASELINE"
          fi

          failed=0
          for dir in $(find . -name "go.mod" -exec dirname {} \;); do
            echo "==> Linting $dir"
            (cd "$dir" && golangci-lint run --timeout=5m $BASELINE_ARG ./...) || failed=1
          done

          if [ $failed -eq 1 ]; then
            echo "Linting failed in one or more modules"
            exit 1
          fi

  frontend:
    name: Frontend tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v3
        with:
          version: 9
      - uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: pnpm
      - run: pnpm install
      - run: pnpm lint
      - run: pnpm build

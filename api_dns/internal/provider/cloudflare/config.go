package cloudflare

import (
	"fmt"

	"frameworks/pkg/config"
)

// Config holds CloudFlare API configuration
type Config struct {
	APIToken  string
	ZoneID    string
	AccountID string
}

// LoadConfig loads CloudFlare configuration from environment
// Reads from CLOUDFLARE_API_TOKEN, CLOUDFLARE_ZONE_ID, CLOUDFLARE_ACCOUNT_ID
// These can be set in shell environment or in .env file (generated by make env)
func LoadConfig() (*Config, error) {
	apiToken := config.GetEnv("CLOUDFLARE_API_TOKEN", "")
	zoneID := config.GetEnv("CLOUDFLARE_ZONE_ID", "")
	accountID := config.GetEnv("CLOUDFLARE_ACCOUNT_ID", "")

	if apiToken == "" {
		return nil, fmt.Errorf("CLOUDFLARE_API_TOKEN is required\n\nSet it in one of:\n  - Shell: export CLOUDFLARE_API_TOKEN=your-token\n  - Config: Add to config/env/secrets.env then run 'make env'\n\nCreate token at: https://dash.cloudflare.com/profile/api-tokens\nRequired permissions: Zone.DNS (Edit), Account.Load Balancers (Edit)")
	}

	if zoneID == "" {
		return nil, fmt.Errorf("CLOUDFLARE_ZONE_ID is required\n\nFind it at: https://dash.cloudflare.com/ → Select your domain → Zone ID\nThen set: export CLOUDFLARE_ZONE_ID=your-zone-id")
	}

	if accountID == "" {
		return nil, fmt.Errorf("CLOUDFLARE_ACCOUNT_ID is required\n\nFind it at: https://dash.cloudflare.com/ → Account Home → Account ID\nThen set: export CLOUDFLARE_ACCOUNT_ID=your-account-id")
	}

	return &Config{
		APIToken:  apiToken,
		ZoneID:    zoneID,
		AccountID: accountID,
	}, nil
}

// NewClientFromConfig creates a CloudFlare client from loaded configuration
func NewClientFromConfig(cfg *Config) *Client {
	return NewClient(cfg.APIToken, cfg.ZoneID, cfg.AccountID)
}

// MustLoadConfig loads configuration and panics on error
// Use for services that require CloudFlare configuration to function
func MustLoadConfig() *Config {
	cfg, err := LoadConfig()
	if err != nil {
		panic(fmt.Sprintf("Failed to load CloudFlare configuration: %v", err))
	}
	return cfg
}

# Fetch stream with analytics summary, viewer time-series, and quality distribution
# Optimized query for analytics dashboard with time-series charts
query GetStreamWithAnalytics(
  $id: ID!
  $streamId: ID!
  $timeRange: TimeRangeInput
  $hourlyFirst: Int = 168
  $healthFirst: Int = 288
  $qualityFirst: Int = 60
) {
  stream(id: $id) {
    id
    name
    playbackId
  }
  analytics {
    usage {
      streaming {
        # MV-backed range aggregates for selected stream
        streamAnalyticsSummary(streamId: $streamId, timeRange: $timeRange) {
          streamId
          rangeAvgViewers
          rangePeakConcurrentViewers
          rangeTotalViews
          rangeTotalSessions
          rangeAvgBufferHealth
          rangeAvgBitrate
          rangeAvgFps
          rangePacketLossRate
          rangeAvgConnectionTime
          rangeViewerHours
          rangeEgressGb
          rangeAvgSessionSeconds
          rangeAvgBytesPerSession
          rangeUniqueViewers
          rangeUniqueCountries
          rangeRebufferCount
          rangeIssueCount
          rangeBufferDryCount
          rangeQuality {
            tier2160pMinutes
            tier1440pMinutes
            tier1080pMinutes
            tier720pMinutes
            tier480pMinutes
            tierSdMinutes
            codecH264Minutes
            codecH265Minutes
          }
        }
        viewerHoursHourlyConnection(streamId: $streamId, timeRange: $timeRange, page: { first: $hourlyFirst }) {
          edges {
            node {
              hour
              streamId
              uniqueViewers
              totalSessionSeconds
              viewerHours
              egressGb
            }
          }
        }
        streamAnalyticsDailyConnection(streamId: $streamId, timeRange: $timeRange, page: { first: 30 }) {
          edges {
            node {
              day
              streamId
              totalViews
              uniqueViewers
              uniqueCountries
              uniqueCities
              egressBytes
            }
          }
        }
        qualityTierDailyConnection(streamId: $streamId, timeRange: $timeRange, page: { first: $qualityFirst }) {
          edges {
            node {
              day
              streamId
              tier2160pMinutes
              tier1440pMinutes
              tier1080pMinutes
              tier720pMinutes
              tier480pMinutes
              tierSdMinutes
              codecH264Minutes
              codecH265Minutes
              avgBitrate
              avgFps
            }
          }
        }
      }
    }
    health {
      streamHealth5mConnection(streamId: $streamId, timeRange: $timeRange, page: { first: $healthFirst }) {
        edges {
          node {
            timestamp
            nodeId
            avgBitrate
            avgFps
            qualityTier
            issueCount
            rebufferCount
          }
        }
      }
    }
  }
}

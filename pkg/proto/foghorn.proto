syntax = "proto3";

package foghorn;

option go_package = "frameworks/pkg/proto";

import "shared.proto";

// =============================================================================
// FOGHORN CONTROL PLANE SERVICES
// These are control-plane operations exposed by Foghorn for Commodore to call.
// Media-plane operations (MistServer control, stream state) remain in ipc.proto.
// =============================================================================

// ClipService handles clip creation and management
service ClipControlService {
  // CreateClip creates a new clip from a stream
  rpc CreateClip(shared.CreateClipRequest) returns (shared.CreateClipResponse);
  // DeleteClip deletes a clip
  rpc DeleteClip(shared.DeleteClipRequest) returns (shared.DeleteClipResponse);
}

// DVRControlService handles DVR recording management
service DVRControlService {
  // StartDVR initiates DVR recording for a stream
  rpc StartDVR(shared.StartDVRRequest) returns (shared.StartDVRResponse);
  // StopDVR stops an active DVR recording
  rpc StopDVR(shared.StopDVRRequest) returns (shared.StopDVRResponse);
  // DeleteDVR deletes a DVR recording and its files
  rpc DeleteDVR(shared.DeleteDVRRequest) returns (shared.DeleteDVRResponse);
}

// ViewerControlService handles viewer and ingest endpoint resolution
service ViewerControlService {
  // ResolveViewerEndpoint resolves the best endpoint(s) for a viewer
  rpc ResolveViewerEndpoint(shared.ViewerEndpointRequest) returns (shared.ViewerEndpointResponse);
  // ResolveIngestEndpoint resolves the best endpoint(s) for StreamCrafter ingest
  rpc ResolveIngestEndpoint(shared.IngestEndpointRequest) returns (shared.IngestEndpointResponse);
}

// VodControlService handles VOD upload management (user-initiated video uploads)
service VodControlService {
  // CreateVodUpload initiates a multipart upload and returns presigned URLs
  rpc CreateVodUpload(shared.CreateVodUploadRequest) returns (shared.CreateVodUploadResponse);
  // CompleteVodUpload finalizes the multipart upload after all parts are uploaded
  rpc CompleteVodUpload(shared.CompleteVodUploadRequest) returns (shared.CompleteVodUploadResponse);
  // AbortVodUpload cancels an in-progress multipart upload
  rpc AbortVodUpload(shared.AbortVodUploadRequest) returns (shared.AbortVodUploadResponse);
  // GetVodAsset returns a single VOD asset by hash
  rpc GetVodAsset(shared.GetVodAssetRequest) returns (shared.VodAssetInfo);
  // ListVodAssets returns paginated list of VOD assets for a tenant
  rpc ListVodAssets(shared.ListVodAssetsRequest) returns (shared.ListVodAssetsResponse);
  // DeleteVodAsset deletes a VOD asset
  rpc DeleteVodAsset(shared.DeleteVodAssetRequest) returns (shared.DeleteVodAssetResponse);
}

// EdgeProvisioningService handles pre-registration of edge nodes during CLI provisioning.
// Uses enrollment tokens for auth (no service token required).
service EdgeProvisioningService {
  // PreRegisterEdge validates an enrollment token and returns an assigned domain for the edge.
  rpc PreRegisterEdge(PreRegisterEdgeRequest) returns (PreRegisterEdgeResponse);
}

message PreRegisterEdgeRequest {
  string enrollment_token = 1;  // Bootstrap token for edge enrollment
  string external_ip = 2;       // Edge's public IP (detected by CLI)
}

message PreRegisterEdgeResponse {
  string node_id = 1;           // Assigned node ID
  string edge_domain = 2;       // e.g., edge-{node_id}.{cluster_slug}.{root_domain}
  string pool_domain = 3;       // e.g., edge.{cluster_slug}.{root_domain}
  string cluster_slug = 4;
  string foghorn_grpc_addr = 5; // Address for Helmsman's FOGHORN_CONTROL_ADDR
  string cert_pem = 6;          // Wildcard TLS certificate (PEM) for the cluster
  string key_pem = 7;           // Corresponding private key (PEM)
  string cluster_id = 8;        // Raw cluster ID (may differ from DNS-safe cluster_slug)
}

// NodeControlService exposes node lifecycle operations.
// Fronts the existing HTTP handlers with tenant ownership validation.
// Commodore proxies this as NodeManagementService for Gateway access.
service NodeControlService {
  // SetNodeOperationalMode changes a node's operational mode (normal, draining, maintenance).
  rpc SetNodeOperationalMode(SetNodeModeRequest) returns (SetNodeModeResponse);
  // GetNodeHealth returns real-time health and routing state for a node.
  rpc GetNodeHealth(GetNodeHealthRequest) returns (GetNodeHealthResponse);
}

message SetNodeModeRequest {
  string node_id = 1;
  string mode = 2;    // "normal", "draining", "maintenance"
  string set_by = 3;  // caller identity for audit trail
}

enum SetNodeModeStatus {
  SET_NODE_MODE_STATUS_UNSPECIFIED = 0;
  SET_NODE_MODE_STATUS_SUCCESS = 1;
  SET_NODE_MODE_STATUS_INVALID_MODE = 2;
  SET_NODE_MODE_STATUS_NOT_FOUND = 3;
  SET_NODE_MODE_STATUS_ALREADY_IN_MODE = 4;
}

message SetNodeModeResponse {
  string node_id = 1;
  string mode = 2;
  string message = 3;
  SetNodeModeStatus status = 4;
}

message GetNodeHealthRequest {
  string node_id = 1;
}

message GetNodeHealthResponse {
  string node_id = 1;
  string operational_mode = 2;
  bool is_healthy = 3;
  int32 active_viewers = 4;
  int32 active_streams = 5;
  string last_heartbeat = 6;  // ISO8601
  string cluster_id = 7;
  string tenant_id = 8;       // owning tenant (empty for operator nodes)
  double cpu_percent = 9;
  double ram_used_mb = 10;
  double ram_max_mb = 11;
  double bandwidth_up_mbps = 12;
  double bandwidth_down_mbps = 13;
  double bw_limit_mbps = 14;
  uint64 disk_total_bytes = 15;
  uint64 disk_used_bytes = 16;
  string location = 17;
  optional double latitude = 18;
  optional double longitude = 19;
}

// TenantControlService handles tenant-level operations called by Purser
service TenantControlService {
  // TerminateTenantStreams stops all active streams for a tenant (called when suspended)
  rpc TerminateTenantStreams(TerminateTenantStreamsRequest) returns (TerminateTenantStreamsResponse);
  // InvalidateTenantCache clears cached suspension status for a tenant (called on reactivation)
  rpc InvalidateTenantCache(InvalidateTenantCacheRequest) returns (InvalidateTenantCacheResponse);
}

// InvalidateTenantCacheRequest is sent when a tenant's suspension status changes
message InvalidateTenantCacheRequest {
  string tenant_id = 1;
  string reason = 2; // e.g., "reactivated", "balance_topped_up"
}

// InvalidateTenantCacheResponse indicates cache entries invalidated
message InvalidateTenantCacheResponse {
  int32 entries_invalidated = 1;
}

// TerminateTenantStreamsRequest is sent by Purser when a tenant is suspended
message TerminateTenantStreamsRequest {
  string tenant_id = 1;
  string reason = 2; // e.g., "insufficient_balance", "suspended"
}

// TerminateTenantStreamsResponse indicates the result of termination
message TerminateTenantStreamsResponse {
  int32 streams_terminated = 1;   // Number of streams that were stopped
  int32 sessions_terminated = 2;  // Total number of sessions stopped
  repeated string stream_names = 3; // Names of streams that were stopped
}

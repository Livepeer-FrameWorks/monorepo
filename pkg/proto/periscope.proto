syntax = "proto3";

package periscope;

option go_package = "frameworks/pkg/proto";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "common.proto";
import "ipc.proto";  // For StreamTrack


// StreamEvent is the canonical analytics stream event returned by Periscope APIs.
message StreamEvent {
  string event_id = 1;  // Used as cursor ID
  google.protobuf.Timestamp timestamp = 2;
  string event_type = 3;
  string status = 4;
  string node_id = 5;
  string event_data = 6;
  google.protobuf.Struct event_payload = 7;
  string stream_id = 8;
  optional string buffer_state = 9;
  optional bool has_issues = 10;
  optional int32 track_count = 11;
  optional string quality_tier = 12;
  optional int32 primary_width = 13;
  optional int32 primary_height = 14;
  optional float primary_fps = 15;
  optional string primary_codec = 16;
  optional int32 primary_bitrate = 17;
  optional uint64 downloaded_bytes = 18;
  optional uint64 uploaded_bytes = 19;
  optional uint32 total_viewers = 20;
  optional int32 total_inputs = 21;
  optional int32 total_outputs = 22;
  optional uint64 viewer_seconds = 23;
  optional string request_url = 24;
  optional string protocol = 25;
  optional double latitude = 26;
  optional double longitude = 27;
  optional string location = 28;
  optional string country_code = 29;
  optional string city = 30;
}

message GetStreamEventsRequest {
  string tenant_id = 1;
  string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetStreamEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated StreamEvent events = 2;
}

message BufferEvent {
  string event_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  string status = 3;
  string node_id = 4;
  string event_data = 5;
  google.protobuf.Struct event_payload = 6;
  string stream_id = 7;
}

message GetBufferEventsRequest {
  string tenant_id = 1;
  string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetBufferEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated BufferEvent events = 2;
}

// Stream end events (filtered stream_events where event_type = 'stream_end')
message EndEvent {
  string event_id = 1;
  google.protobuf.Timestamp timestamp = 2;
  string status = 3;
  string node_id = 4;
  string event_data = 5;
  google.protobuf.Struct event_payload = 6;
}

message GetEndEventsRequest {
  string tenant_id = 1;
  string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetEndEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated EndEvent events = 2;
}

message StreamHealthMetric {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string tenant_id = 3;
  string stream_id = 4;
  string node_id = 5;
  int32 bitrate = 6;
  float fps = 7;
  int32 gop_size = 8;
  optional float frame_ms_max = 36;
  optional float frame_ms_min = 37;
  optional int32 frames_max = 38;
  optional int32 frames_min = 39;
  optional float keyframe_ms_max = 40;
  optional float keyframe_ms_min = 41;
  int32 width = 9;
  int32 height = 10;
  int32 buffer_size = 11;
  int32 buffer_used = 12;
  float buffer_health = 13;
  int64 packets_sent = 14;
  int64 packets_lost = 15;
  int64 packets_retransmitted = 16;
  int64 bandwidth_in = 17;
  int64 bandwidth_out = 18;
  string codec = 19;
  string profile = 20;
  repeated helmsmancontrol.StreamTrack tracks = 21;
  // REMOVED: health_score = 22 (no data source - derive from buffer_state/packet_loss if needed)
  optional double frame_jitter_ms = 23;
  optional double keyframe_stability_ms = 24;
  optional string issues_description = 25;
  optional bool has_issues = 26;
  optional double packet_loss_percentage = 27;
  optional string quality_tier = 28;
  string buffer_state = 29;

  // Primary audio track info (matches HTTP types)
  optional int32 primary_audio_channels = 30;
  optional int32 primary_audio_sample_rate = 31;
  optional string primary_audio_codec = 32;
  optional int32 primary_audio_bitrate = 33;
  string track_metadata = 34;  // json:"track_metadata" - Raw JSON of track metadata
  optional int32 track_count = 35;
}

message GetStreamHealthMetricsRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetStreamHealthMetricsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated StreamHealthMetric metrics = 2;
}

// ============================================================================
// Viewer Analytics
// ============================================================================

message ViewerHistoryEntry {
  google.protobuf.Timestamp timestamp = 1;
  int32 viewer_count = 2;
  string connection_type = 3;
  float buffer_health = 4;
  float connection_quality = 5;
  string country_code = 6;
  string city = 7;
}

message ViewerGeographicStats {
  int32 unique_countries = 1;
  int32 unique_cities = 2;
  map<string, int32> country_breakdown = 3;
  string city_breakdown_json = 4;
}

message GetViewerStatsRequest {
  string tenant_id = 1;
  string stream_id = 2;
}

message GetViewerStatsResponse {
  int32 current_viewers = 1;
  int32 peak_viewers = 2;
  int32 total_connections = 3;
  repeated ViewerHistoryEntry viewer_history = 4;
  ViewerGeographicStats geo_stats = 5;
}

message ViewerSession {
  string session_id = 1;  // Used as cursor ID
  google.protobuf.Timestamp timestamp = 2;
  string stream_id = 3;
  string tenant_id = 4;
  string node_id = 5;
  string connection_addr = 6;
  string connector = 7;
  string country_code = 8;
  string city = 9;
  double latitude = 10;
  double longitude = 11;
  int64 duration_seconds = 12;
  int64 bytes_up = 13;
  int64 bytes_down = 14;
  int32 viewer_count = 15;
  string connection_type = 16;
  float connection_quality = 17;
  float buffer_health = 18;
  optional helmsmancontrol.GeoBucket client_bucket = 19;
  optional google.protobuf.Timestamp connected_at = 20;
  optional google.protobuf.Timestamp disconnected_at = 21;
}

message GetViewerMetricsRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetViewerMetricsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated ViewerSession sessions = 2;
}

// Time-bucketed viewer count data for time-series charts
message ViewerCountBucket {
  google.protobuf.Timestamp timestamp = 1;
  int32 viewer_count = 2;
  string stream_id = 3;
}

message GetViewerCountTimeSeriesRequest {
  string tenant_id = 1;
  optional string stream_id = 2;   // Filter by stream, or all streams if omitted
  common.TimeRange time_range = 3;
  string interval = 4;             // Bucket interval: "5m", "15m", "1h", "1d"
}

message GetViewerCountTimeSeriesResponse {
  repeated ViewerCountBucket buckets = 1;
}

// Aggregated geographic distribution
message CountryMetric {
  string country_code = 1;
  int32 viewer_count = 2;
  float percentage = 3;
  double viewer_hours = 4;
  double egress_gb = 5;
}

message CityMetric {
  string city = 1;
  string country_code = 2;
  int32 viewer_count = 3;
  float percentage = 4;
  double latitude = 5;
  double longitude = 6;
}

message GetGeographicDistributionRequest {
  string tenant_id = 1;
  optional string stream_id = 2;   // Filter by stream, or all streams if omitted
  common.TimeRange time_range = 3;
  int32 top_n = 4;                 // Limit results, default 10
}

message GetGeographicDistributionResponse {
  repeated CountryMetric top_countries = 1;
  repeated CityMetric top_cities = 2;
  int32 unique_countries = 3;
  int32 unique_cities = 4;
  int32 total_viewers = 5;
}

// ============================================================================
// Track Analytics
// ============================================================================

message TrackListEvent {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string node_id = 3;
  string track_list = 4;  // Raw JSON
  repeated helmsmancontrol.StreamTrack tracks = 5;
  int32 track_count = 6;
  string stream_id = 7;
}

message GetTrackListEventsRequest {
  string tenant_id = 1;
  string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetTrackListEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated TrackListEvent events = 2;
}

// ============================================================================
// Connection Analytics
// ============================================================================

message ConnectionEvent {
  string event_id = 1;  // Used as cursor ID
  google.protobuf.Timestamp timestamp = 2;
  string tenant_id = 3;
  string stream_id = 4;
  string session_id = 5;
  string connection_addr = 6;
  string connector = 7;
  string node_id = 8;
  string country_code = 9;
  string city = 10;
  double latitude = 11;   // centroid
  double longitude = 12;  // centroid
  string event_type = 13;  // "connect" or "disconnect"
  helmsmancontrol.GeoBucket client_bucket = 14;
  helmsmancontrol.GeoBucket node_bucket = 15;
  uint32 session_duration_seconds = 16;  // Duration of session (disconnect events)
  uint64 bytes_transferred = 17;         // Bytes transferred during session
  optional string request_url = 18;
}

message GetConnectionEventsRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetConnectionEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated ConnectionEvent events = 2;
}

// ============================================================================
// Node Analytics
// ============================================================================

message NodeMetric {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string node_id = 3;
  string cluster_id = 23;
  float cpu_usage = 4;
  uint64 ram_max = 5;
  uint64 ram_current = 6;
  uint64 shm_total_bytes = 7;
  uint64 shm_used_bytes = 8;
  uint64 disk_total_bytes = 9;
  uint64 disk_used_bytes = 10;
  int64 bandwidth_in = 11;
  int64 bandwidth_out = 12;
  uint64 up_speed = 13;
  uint64 down_speed = 14;
  int32 connections_current = 15;
  int32 stream_count = 16;
  // REMOVED: health_score = 17 (no data source - use is_healthy instead)
  bool is_healthy = 18;
  double latitude = 19;
  double longitude = 20;
  repeated string tags = 21;
  google.protobuf.Struct metadata = 22;
}

message GetNodeMetricsRequest {
  string tenant_id = 1;
  optional string node_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetNodeMetricsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated NodeMetric metrics = 2;
}

message NodeMetricHourly {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string node_id = 3;
  string cluster_id = 16;
  float avg_cpu = 4;
  float peak_cpu = 5;
  float avg_memory = 6;
  float peak_memory = 7;
  int64 total_bandwidth_in = 8;
  int64 total_bandwidth_out = 9;
  // REMOVED: avg_health_score = 10 (no data source - use was_healthy instead)
  bool was_healthy = 11;
  float avg_disk = 12;
  float peak_disk = 13;
  float avg_shm = 14;
  float peak_shm = 15;
}

message NodeMetricsAggregated {
  string node_id = 1;
  string cluster_id = 2;
  float avg_cpu = 3;
  float avg_memory = 4;
  float avg_disk = 5;
  float avg_shm = 6;
  int64 total_bandwidth_in = 7;
  int64 total_bandwidth_out = 8;
  uint32 sample_count = 9;
}

message GetNodeMetrics1hRequest {
  string tenant_id = 1;
  optional string node_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetNodeMetrics1hResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated NodeMetricHourly metrics = 2;
}

message GetNodeMetricsAggregatedRequest {
  string tenant_id = 1;
  optional string node_id = 2;
  common.TimeRange time_range = 3;
}

message GetNodeMetricsAggregatedResponse {
  repeated NodeMetricsAggregated metrics = 1;
}

// Live node state (from live_nodes ReplacingMergeTree - current state, not time-series)
message LiveNode {
  string node_id = 1;
  string tenant_id = 2;

  // Resources
  float cpu_percent = 3;
  uint64 ram_used_bytes = 4;
  uint64 ram_total_bytes = 5;
  uint64 disk_used_bytes = 6;
  uint64 disk_total_bytes = 7;

  // Network
  uint64 up_speed = 8;
  uint64 down_speed = 9;

  // Streams
  uint32 active_streams = 10;

  // Health
  bool is_healthy = 11;

  // Location
  double latitude = 12;
  double longitude = 13;
  string location = 14;

  // Metadata
  google.protobuf.Struct metadata = 15;

  // Timing
  google.protobuf.Timestamp updated_at = 16;
}

message GetLiveNodesRequest {
  string tenant_id = 1;
  optional string node_id = 2;  // Filter by specific node
  repeated string related_tenant_ids = 3;  // Include nodes from subscribed clusters
}

message GetLiveNodesResponse {
  repeated LiveNode nodes = 1;
  int32 count = 2;
}

// ============================================================================
// Routing Analytics
// ============================================================================

message RoutingEvent {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string stream_id = 3;
  string selected_node = 4;
  optional string node_id = 5;
  // client_ip intentionally omitted (PII)
  // optional string client_ip = 6;
  optional string client_country = 7;
  optional double client_latitude = 8; // centroid
  optional double client_longitude = 9; // centroid
  optional double node_latitude = 10; // centroid
  optional double node_longitude = 11; // centroid
  optional string node_name = 12;
  optional int32 score = 13;
  string status = 14;
  optional string details = 15;
  optional double routing_distance = 16;  // Distance in km
  optional string event_type = 17;
  optional string source = 18;
  // Additional analytics fields
  // Field 19 removed (algorithm) - not implemented in Foghorn yet
  int32 candidates_count = 20;
  float latency_ms = 21;
  string tenant_id = 22;                    // Infra owner tenant (cluster operator)
  optional helmsmancontrol.GeoBucket client_bucket = 23;
  optional helmsmancontrol.GeoBucket node_bucket = 24;
  // Dual-tenant attribution (RFC: routing-events-dual-tenant-attribution)
  optional string stream_tenant_id = 25;    // Subject tenant (stream/customer owner)
  optional string cluster_id = 26;          // Emitting cluster identifier
}

message GetRoutingEventsRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
  repeated string related_tenant_ids = 5;
  // Dual-tenant filtering (RFC: routing-events-dual-tenant-attribution)
  optional string stream_tenant_id = 6;     // Filter by subject tenant (stream owner)
  optional string cluster_id = 7;           // Filter by cluster
}

message GetRoutingEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated RoutingEvent events = 2;
}

// ============================================================================
// Realtime Analytics
// ============================================================================

message RealtimeStream {
  string stream_id = 1;
  int32 current_viewers = 2;
  int64 bandwidth_in = 3;
  int64 bandwidth_out = 4;
  string status = 5;
  string node_id = 6;
  string location = 7;
  double viewer_trend = 8;
  float buffer_health = 9;
  float connection_quality = 10;
  int32 unique_countries = 11;
}

message GetRealtimeStreamsRequest {
  string tenant_id = 1;
}

message GetRealtimeStreamsResponse {
  repeated RealtimeStream streams = 1;
  int32 count = 2;
}

message RealtimeStreamViewer {
  string stream_id = 1;
  double avg_viewers = 2;
  double peak_viewers = 3;
  int32 unique_countries = 4;
  int32 unique_cities = 5;
}

message GetRealtimeViewersRequest {
  string tenant_id = 1;
}

message GetRealtimeViewersResponse {
  int32 total_viewers = 1;
  repeated RealtimeStreamViewer stream_viewers = 2;
}

message RealtimeEvent {
  google.protobuf.Timestamp timestamp = 1;
  string event_type = 2;
  optional StreamEvent stream_event = 3;
  optional ConnectionEvent connection_event = 4;
  optional BufferEvent buffer_event = 5;
  optional ViewerHistoryEntry viewer_metrics = 6;
}

message GetRealtimeEventsRequest {
  string tenant_id = 1;
}

message GetRealtimeEventsResponse {
  repeated RealtimeEvent events = 1;
  int32 count = 2;
}

// ============================================================================
// Platform Analytics
// ============================================================================

message GetPlatformOverviewRequest {
  string tenant_id = 1;
  common.TimeRange time_range = 2;
}

message GetPlatformOverviewResponse {
  string tenant_id = 1;
  reserved 2, 3;  // Removed: total_sessions, active_sessions (redundant with viewer metrics)
  int32 total_streams = 4;
  int32 active_streams = 5;
  int32 total_viewers = 6;
  double average_viewers = 7;
  double peak_bandwidth = 8;
  google.protobuf.Timestamp generated_at = 9;

  // Additional platform metrics for dashboard
  double stream_hours = 10;             // Total streaming hours in time range (ingest hours)
  double egress_gb = 11;                // Total egress bandwidth in GB
  int32 peak_viewers = 12;              // Peak concurrent viewers in time range (NOTE: currently unique_viewers)

  // Real-time bandwidth metrics (from live_streams)
  uint64 total_upload_bytes = 13;       // Total ingest bytes (sum of uploaded_bytes)
  uint64 total_download_bytes = 14;     // Total egress bytes (sum of downloaded_bytes)

  // Viewer consumption metrics (from tenant_viewer_daily)
  double viewer_hours = 15;             // Total accumulated viewer watch time in hours
  double delivered_minutes = 16;        // viewer_hours * 60 (convenience field)
  int32 unique_viewers = 17;            // Unique viewer count for the time range
  double ingest_hours = 18;             // Total hours streams were live (alias for stream_hours)

  // True peak concurrent viewers (from stream_events max(total_viewers))
  int32 peak_concurrent_viewers = 19;   // Maximum concurrent viewers at any instant in time range

  // Total views count (from tenant_analytics_daily - connection events)
  int64 total_views = 20;               // Total number of view sessions started in time range

  // Echoed time range used for aggregation (for UI consistency)
  common.TimeRange time_range = 21;
}

// ============================================================================
// Clip Analytics
// ============================================================================

message ClipEvent {
  string request_id = 1;  // Used as cursor ID
  google.protobuf.Timestamp timestamp = 2;
  string stream_id = 3;
  string stage = 4;
  optional string content_type = 5;
  optional int64 start_unix = 6;
  optional int64 stop_unix = 7;
  optional string ingest_node_id = 8;
  optional uint32 percent = 9;
  optional string message = 10;
  optional string file_path = 11;
  optional string s3_url = 12;
  optional uint64 size_bytes = 13;
  optional int64 expires_at = 14;
}

message GetClipEventsRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  optional string stage = 3;
  optional string content_type = 6; // clip|dvr|vod (artifact lifecycle)
  common.TimeRange time_range = 4;
  common.CursorPaginationRequest pagination = 5;
}

message GetClipEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated ClipEvent events = 2;
}

// Artifact state (current status of clips/DVR/VOD from live_artifacts table)
message ArtifactState {
  string tenant_id = 1;
  string request_id = 2;          // clip_hash, dvr_hash, or vod_hash
  string stream_id = 3;           // source stream
  string content_type = 4;        // 'clip', 'dvr', or 'vod'
  string stage = 5;               // requested, queued, processing, completed, failed, deleted
  uint32 progress_percent = 6;
  optional string error_message = 7;
  google.protobuf.Timestamp requested_at = 8;
  optional google.protobuf.Timestamp started_at = 9;
  optional google.protobuf.Timestamp completed_at = 10;
  optional int64 clip_start_unix = 11;
  optional int64 clip_stop_unix = 12;
  optional uint32 segment_count = 13;
  optional string manifest_path = 14;
  optional string file_path = 15;
  optional string s3_url = 16;
  optional uint64 size_bytes = 17;
  optional string processing_node_id = 18;
  google.protobuf.Timestamp updated_at = 19;
  optional google.protobuf.Timestamp expires_at = 20;
}

message GetArtifactStateRequest {
  string tenant_id = 1;
  string request_id = 2;          // clip_hash, dvr_hash, or vod_hash
}

message GetArtifactStateResponse {
  ArtifactState artifact = 1;
}

message GetArtifactStatesRequest {
  string tenant_id = 1;
  optional string stream_id = 2;       // filter by source stream
  optional string content_type = 3;    // filter by 'clip', 'dvr', or 'vod'
  optional string stage = 4;           // filter by stage
  common.CursorPaginationRequest pagination = 5;
  repeated string request_ids = 6;     // batch lookup by artifact hash (for field resolvers)
}

message GetArtifactStatesResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated ArtifactState artifacts = 2;
}

// ============================================================================
// Stream Status (Control/Data Plane Separation)
// Gateway queries this for operational state instead of Commodore
// ============================================================================

message GetStreamStatusRequest {
  string tenant_id = 1;
  string stream_id = 2;
}

message StreamStatusResponse {
  string stream_id = 1;
  string status = 2;                               // "live", "offline"
  google.protobuf.Timestamp started_at = 3;
  google.protobuf.Timestamp ended_at = 4;
  int64 current_viewers = 5;
  int64 peak_viewers = 6;
  int64 total_views = 7;
  int64 duration_seconds = 8;
  google.protobuf.Timestamp last_event_at = 9;     // Most recent event timestamp
  string last_event_type = 10;                     // Most recent event type (e.g., "stream-start", "stream-end")

  // Quality metrics (from live_streams table)
  optional string buffer_state = 11;
  optional string quality_tier = 12;
  optional int32 primary_width = 13;
  optional int32 primary_height = 14;
  optional float primary_fps = 15;
  optional string primary_codec = 16;
  optional int32 primary_bitrate = 17;
  optional bool has_issues = 18;
  optional string issues_description = 19;

  // Current state identifiers / counters (from stream_state_current)
  optional string node_id = 20;
  optional int32 track_count = 21;
  optional int32 total_inputs = 22;
  optional uint64 uploaded_bytes = 23;
  optional uint64 downloaded_bytes = 24;
  optional uint64 viewer_seconds = 25;
  optional uint64 packets_sent = 26;
  optional uint64 packets_lost = 27;
  optional uint64 packets_retransmitted = 28;
  optional google.protobuf.Timestamp updated_at = 29;
}

message GetStreamsStatusRequest {
  string tenant_id = 1;
  repeated string stream_ids = 2;
}

message StreamsStatusResponse {
  map<string, StreamStatusResponse> statuses = 1;  // keyed by stream_id
}

// ============================================================================
// Services
// ============================================================================

service StreamAnalyticsService {
  rpc GetStreamEvents(GetStreamEventsRequest) returns (GetStreamEventsResponse);
  rpc GetBufferEvents(GetBufferEventsRequest) returns (GetBufferEventsResponse);
  rpc GetStreamHealthMetrics(GetStreamHealthMetricsRequest) returns (GetStreamHealthMetricsResponse);
  // Stream status for Control/Data plane separation
  rpc GetStreamStatus(GetStreamStatusRequest) returns (StreamStatusResponse);
  rpc GetStreamsStatus(GetStreamsStatusRequest) returns (StreamsStatusResponse);
}

service ViewerAnalyticsService {
  rpc GetViewerMetrics(GetViewerMetricsRequest) returns (GetViewerMetricsResponse);
  rpc GetViewerCountTimeSeries(GetViewerCountTimeSeriesRequest) returns (GetViewerCountTimeSeriesResponse);
  rpc GetGeographicDistribution(GetGeographicDistributionRequest) returns (GetGeographicDistributionResponse);
}

service TrackAnalyticsService {
  rpc GetTrackListEvents(GetTrackListEventsRequest) returns (GetTrackListEventsResponse);
}

service ConnectionAnalyticsService {
  rpc GetConnectionEvents(GetConnectionEventsRequest) returns (GetConnectionEventsResponse);
}

service NodeAnalyticsService {
  rpc GetNodeMetrics(GetNodeMetricsRequest) returns (GetNodeMetricsResponse);
  rpc GetNodeMetrics1h(GetNodeMetrics1hRequest) returns (GetNodeMetrics1hResponse);
  rpc GetNodeMetricsAggregated(GetNodeMetricsAggregatedRequest) returns (GetNodeMetricsAggregatedResponse);
  // Live node state queries (from live_nodes ReplacingMergeTree)
  rpc GetLiveNodes(GetLiveNodesRequest) returns (GetLiveNodesResponse);
}

service RoutingAnalyticsService {
  rpc GetRoutingEvents(GetRoutingEventsRequest) returns (GetRoutingEventsResponse);
}

service PlatformAnalyticsService {
  rpc GetPlatformOverview(GetPlatformOverviewRequest) returns (GetPlatformOverviewResponse);
}

service ClipAnalyticsService {
  rpc GetClipEvents(GetClipEventsRequest) returns (GetClipEventsResponse);
  // Artifact state queries (live_artifacts table - current state)
  rpc GetArtifactState(GetArtifactStateRequest) returns (GetArtifactStateResponse);
  rpc GetArtifactStates(GetArtifactStatesRequest) returns (GetArtifactStatesResponse);
}

// ============================================================================
// Materialized View Analytics (Pre-Aggregated Data)
// ============================================================================

// Stream connection hourly aggregates (from stream_connection_hourly MV)
message StreamConnectionHourly {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp hour = 2;
  string tenant_id = 3;
  string stream_id = 4;
  uint64 total_bytes = 5;
  uint64 unique_viewers = 6;
  uint64 total_sessions = 7;
}

message GetStreamConnectionHourlyRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetStreamConnectionHourlyResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated StreamConnectionHourly records = 2;
}

// Client metrics 5-minute aggregates (from client_metrics_5m MV)
message ClientMetrics5m {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string tenant_id = 3;
  string stream_id = 4;
  string node_id = 5;
  uint32 active_sessions = 6;
  double avg_bandwidth_in = 7;
  double avg_bandwidth_out = 8;
  float avg_connection_time = 9;
  optional float packet_loss_rate = 10;
}

message GetClientMetrics5mRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  optional string node_id = 3;
  common.TimeRange time_range = 4;
  common.CursorPaginationRequest pagination = 5;
}

message GetClientMetrics5mResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated ClientMetrics5m records = 2;
}

// Quality tier daily distribution (from quality_tier_daily MV)
message QualityTierDaily {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp day = 2;
  string tenant_id = 3;
  string stream_id = 4;
  uint32 tier_2160p_minutes = 5;
  uint32 tier_1440p_minutes = 6;
  uint32 tier_1080p_minutes = 7;
  uint32 tier_720p_minutes = 8;
  uint32 tier_480p_minutes = 9;
  uint32 tier_sd_minutes = 10;
  string primary_tier = 11;
  uint32 codec_h264_minutes = 12;
  uint32 codec_h265_minutes = 13;
  uint32 codec_vp9_minutes = 16;
  uint32 codec_av1_minutes = 17;
  uint32 avg_bitrate = 14;
  float avg_fps = 15;
}

message GetQualityTierDailyRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetQualityTierDailyResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated QualityTierDaily records = 2;
}

// Storage usage record (from storage_snapshots table)
// Named "StorageUsageRecord" to avoid conflict with ipc.proto StorageSnapshot
message StorageUsageRecord {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string tenant_id = 3;
  string node_id = 4;
  uint64 total_bytes = 5;
  uint32 file_count = 6;
  uint64 dvr_bytes = 7;
  uint64 clip_bytes = 8;
  uint64 vod_bytes = 9;
  // Frozen storage breakdown (cold storage in S3)
  uint64 frozen_dvr_bytes = 10;
  uint64 frozen_clip_bytes = 11;
  uint64 frozen_vod_bytes = 12;
  string storage_scope = 13; // hot | cold
}

// Storage lifecycle event (freeze/defrost operations)
message StorageEvent {
  string id = 1;  // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string tenant_id = 3;
  string stream_id = 4;
  string asset_hash = 5;           // clip_hash or dvr_hash
  string action = 6;               // freeze_started, frozen, defrost_started, defrosted, freeze_failed, defrost_failed
  string asset_type = 7;           // clip, dvr
  uint64 size_bytes = 8;
  optional string s3_url = 9;
  optional string local_path = 10;
  string node_id = 11;
  optional int64 duration_ms = 12; // Time taken for operation
  optional string error = 13;
  optional int64 warm_duration_ms = 14;
}

message GetStorageEventsRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  optional string asset_type = 3;   // filter: clip or dvr
  common.TimeRange time_range = 4;
  common.CursorPaginationRequest pagination = 5;
}

message GetStorageEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated StorageEvent events = 2;
}

message GetStorageUsageRequest {
  string tenant_id = 1;
  optional string node_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
  optional string storage_scope = 5;
}

message GetStorageUsageResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated StorageUsageRecord records = 2;
}

// Live usage summary for billing dashboards (near-real-time)
message GetLiveUsageSummaryRequest {
  string tenant_id = 1;
  common.TimeRange time_range = 2;
}

message LiveUsageSummary {
  string tenant_id = 1;
  google.protobuf.Timestamp period_start = 2;
  google.protobuf.Timestamp period_end = 3;

  // Core metrics (matches UsageSummary)
  double stream_hours = 4;
  double egress_gb = 5;
  double peak_bandwidth_mbps = 6;
  double average_storage_gb = 7;

  // Per-codec breakdown: Livepeer
  double livepeer_h264_seconds = 8;
  double livepeer_vp9_seconds = 9;
  double livepeer_av1_seconds = 10;
  double livepeer_hevc_seconds = 11;

  // Per-codec breakdown: Native AV
  double native_av_h264_seconds = 12;
  double native_av_vp9_seconds = 13;
  double native_av_av1_seconds = 14;
  double native_av_hevc_seconds = 15;
  double native_av_aac_seconds = 16;
  double native_av_opus_seconds = 17;

  // Viewer metrics (matches UsageSummary)
  int32 total_streams = 18;
  int32 total_viewers = 19;
  double viewer_hours = 20;
  int32 max_viewers = 21;
  int32 unique_users = 22;

  // Segment/stream counts (from processing_daily)
  uint64 livepeer_segment_count = 23;
  uint32 livepeer_unique_streams = 24;
  uint64 native_av_segment_count = 25;
  uint32 native_av_unique_streams = 26;

  // Geo enrichment (from viewer_connection_events)
  int32 unique_countries = 27;
  int32 unique_cities = 28;
  repeated CountryMetric geo_breakdown = 29;

  // Storage lifecycle - artifact counts (from artifact_events)
  uint32 clips_created = 30;
  uint32 clips_deleted = 31;
  uint32 dvr_created = 32;
  uint32 dvr_deleted = 33;
  uint32 vod_created = 34;
  uint32 vod_deleted = 35;

  // Storage lifecycle - bytes by type (hot storage)
  uint64 clip_bytes = 36;
  uint64 dvr_bytes = 37;
  uint64 vod_bytes = 38;

  // Storage lifecycle - frozen bytes (cold storage)
  uint64 frozen_clip_bytes = 39;
  uint64 frozen_dvr_bytes = 40;
  uint64 frozen_vod_bytes = 41;

  // Freeze/defrost operations (from storage_events)
  uint32 freeze_count = 42;
  uint64 freeze_bytes = 43;
  uint32 defrost_count = 44;
  uint64 defrost_bytes = 45;
}

message GetLiveUsageSummaryResponse {
  LiveUsageSummary summary = 1;
}

// Service for materialized view analytics
service AggregatedAnalyticsService {
  rpc GetStreamConnectionHourly(GetStreamConnectionHourlyRequest) returns (GetStreamConnectionHourlyResponse);
  rpc GetClientMetrics5m(GetClientMetrics5mRequest) returns (GetClientMetrics5mResponse);
  rpc GetQualityTierDaily(GetQualityTierDailyRequest) returns (GetQualityTierDailyResponse);
  rpc GetStreamAnalyticsSummary(GetStreamAnalyticsSummaryRequest) returns (GetStreamAnalyticsSummaryResponse);
  rpc GetStreamAnalyticsSummaries(GetStreamAnalyticsSummariesRequest) returns (GetStreamAnalyticsSummariesResponse);
  rpc GetStorageUsage(GetStorageUsageRequest) returns (GetStorageUsageResponse);
  rpc GetStorageEvents(GetStorageEventsRequest) returns (GetStorageEventsResponse);
  rpc GetStreamHealth5m(GetStreamHealth5mRequest) returns (GetStreamHealth5mResponse);
  rpc GetNodePerformance5m(GetNodePerformance5mRequest) returns (GetNodePerformance5mResponse);
  rpc GetViewerHoursHourly(GetViewerHoursHourlyRequest) returns (GetViewerHoursHourlyResponse);
  rpc GetViewerGeoHourly(GetViewerGeoHourlyRequest) returns (GetViewerGeoHourlyResponse);
  rpc GetTenantDailyStats(GetTenantDailyStatsRequest) returns (GetTenantDailyStatsResponse);
  rpc GetProcessingUsage(GetProcessingUsageRequest) returns (GetProcessingUsageResponse);
  rpc GetLiveUsageSummary(GetLiveUsageSummaryRequest) returns (GetLiveUsageSummaryResponse);
  // Newly exposed tables
  rpc GetRebufferingEvents(GetRebufferingEventsRequest) returns (GetRebufferingEventsResponse);
  rpc GetTenantAnalyticsDaily(GetTenantAnalyticsDailyRequest) returns (GetTenantAnalyticsDailyResponse);
  rpc GetStreamAnalyticsDaily(GetStreamAnalyticsDailyRequest) returns (GetStreamAnalyticsDailyResponse);
  rpc GetAPIUsage(GetAPIUsageRequest) returns (GetAPIUsageResponse);
}

// ============================================================================
// Stream Health 5-Minute Aggregates (from stream_health_5m MV)
// ============================================================================

message StreamHealth5m {
  string id = 1;
  google.protobuf.Timestamp timestamp = 2;
  string tenant_id = 3;
  string stream_id = 4;
  string node_id = 5;
  int32 rebuffer_count = 6;
  int32 issue_count = 7;
  string sample_issues = 8;
  int32 avg_bitrate = 9;
  float avg_fps = 10;
  float avg_buffer_health = 11;
  optional float avg_frame_jitter_ms = 14;
  optional float max_frame_jitter_ms = 15;
  int32 buffer_dry_count = 12;
  string quality_tier = 13;
}

message GetStreamHealth5mRequest {
  string tenant_id = 1;
  string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetStreamHealth5mResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated StreamHealth5m records = 2;
}

// ============================================================================
// Node Performance 5-Minute Aggregates (from node_performance_5m MV)
// ============================================================================

message NodePerformance5m {
  string id = 1;
  google.protobuf.Timestamp timestamp = 2;
  string node_id = 3;
  float avg_cpu = 4;
  float max_cpu = 5;
  float avg_memory = 6;
  float max_memory = 7;
  int64 total_bandwidth = 8;
  int32 avg_streams = 9;
  int32 max_streams = 10;
}

message GetNodePerformance5mRequest {
  string tenant_id = 1;
  optional string node_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetNodePerformance5mResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated NodePerformance5m records = 2;
}

// ============================================================================
// Viewer Hours Hourly Aggregates (from viewer_hours_hourly MV)
// ============================================================================

message ViewerHoursHourly {
  string id = 1;
  google.protobuf.Timestamp hour = 2;
  string tenant_id = 3;
  string stream_id = 4;
  string country_code = 5;
  int32 unique_viewers = 6;
  int64 total_session_seconds = 7;
  int64 total_bytes = 8;
}

message GetViewerHoursHourlyRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetViewerHoursHourlyResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated ViewerHoursHourly records = 2;
}

// ============================================================================
// Viewer Geographic Hourly Aggregates (from viewer_geo_hourly MV)
// ============================================================================

message ViewerGeoHourly {
  string id = 1;
  google.protobuf.Timestamp hour = 2;
  string tenant_id = 3;
  string country_code = 4;
  int32 viewer_count = 5;
  double viewer_hours = 6;
  double egress_gb = 7;
}

message GetViewerGeoHourlyRequest {
  string tenant_id = 1;
  optional string stream_id = 2;
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetViewerGeoHourlyResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated ViewerGeoHourly records = 2;
}

// ============================================================================
// Tenant Daily Stats (from tenant_viewer_daily for PlatformOverview.dailyStats)
// ============================================================================

message TenantDailyStat {
  string id = 1;
  google.protobuf.Timestamp date = 2;
  string tenant_id = 3;
  double egress_gb = 4;
  double viewer_hours = 5;
  int32 unique_viewers = 6;
  int32 total_sessions = 7;
  int64 total_views = 8;
}

message GetTenantDailyStatsRequest {
  string tenant_id = 1;
  int32 days = 2;
}

message GetTenantDailyStatsResponse {
  repeated TenantDailyStat stats = 1;
}

// ============================================================================
// Processing Usage (from process_billing and process_billing_daily tables)
// ============================================================================

// Individual processing billing record (from process_billing table)
message ProcessingUsageRecord {
  string id = 1;
  google.protobuf.Timestamp timestamp = 2;
  string tenant_id = 3;
  string node_id = 4;
  string stream_id = 5;
  string process_type = 6;           // "Livepeer", "AV", "FFmpeg"
  int64 duration_ms = 7;
  optional string input_codec = 8;
  optional string output_codec = 9;
  optional string track_type = 10;   // "audio" or "video" - KEY FOR BILLING

  // Livepeer-specific
  optional int32 segment_number = 20;
  optional int32 width = 21;              // source width
  optional int32 height = 22;             // source height
  optional int32 rendition_count = 23;
  optional string broadcaster_url = 24;
  optional int64 upload_time_us = 25;     // DEPRECATED: use turnaround_ms
  optional string livepeer_session_id = 26;
  optional int64 segment_start_ms = 27;
  optional int64 input_bytes = 28;
  optional int64 output_bytes_total = 29;
  optional int32 attempt_count = 30;
  optional int64 turnaround_ms = 31;
  optional double speed_factor = 32;
  optional string renditions_json = 33;   // JSON array: [{name, bytes}, ...]

  // MistProcAV cumulative
  optional int64 input_frames = 40;
  optional int64 output_frames = 41;
  optional int64 decode_us_per_frame = 42;
  optional int64 transform_us_per_frame = 43;
  optional int64 encode_us_per_frame = 44;
  optional bool is_final = 45;

  // MistProcAV delta values
  optional int64 input_frames_delta = 50;
  optional int64 output_frames_delta = 51;
  optional int64 input_bytes_delta = 52;
  optional int64 output_bytes_delta = 53;

  // MistProcAV dimensions
  optional int32 input_width = 54;
  optional int32 input_height = 55;
  optional int32 output_width = 56;
  optional int32 output_height = 57;

  // MistProcAV frame/audio info
  optional int32 input_fpks = 58;
  optional double output_fps_measured = 59;
  optional int32 sample_rate = 60;
  optional int32 channels = 61;

  // MistProcAV timing
  optional int64 source_timestamp_ms = 62;
  optional int64 sink_timestamp_ms = 63;
  optional int64 source_advanced_ms = 64;
  optional int64 sink_advanced_ms = 65;

  // MistProcAV performance
  optional double rtf_in = 66;
  optional double rtf_out = 67;
  optional int64 pipeline_lag_ms = 68;
  optional int64 output_bitrate_bps = 69;
}

// Daily processing usage summary (from process_billing_daily table)
message ProcessingUsageSummary {
  google.protobuf.Timestamp date = 1;
  string tenant_id = 2;
  // Livepeer (totals)
  double livepeer_seconds = 3;
  uint64 livepeer_segment_count = 4;
  uint32 livepeer_unique_streams = 5;
  // Livepeer per-codec breakdown
  double livepeer_h264_seconds = 10;
  double livepeer_vp9_seconds = 11;
  double livepeer_av1_seconds = 12;
  double livepeer_hevc_seconds = 13;
  // Native AV (totals)
  double native_av_seconds = 6;
  uint64 native_av_segment_count = 7;
  uint32 native_av_unique_streams = 8;
  // Native AV per-codec breakdown
  double native_av_h264_seconds = 14;
  double native_av_vp9_seconds = 15;
  double native_av_av1_seconds = 16;
  double native_av_hevc_seconds = 17;
  double native_av_aac_seconds = 18;
  double native_av_opus_seconds = 19;
  // Track type aggregates
  double audio_seconds = 20;
  double video_seconds = 21;
}

message GetProcessingUsageRequest {
  string tenant_id = 1;
  optional string stream_id = 2;        // Filter by stream
  optional string process_type = 3;     // Filter by process type ("Livepeer", "AV", "FFmpeg")
  common.TimeRange time_range = 4;
  common.CursorPaginationRequest pagination = 5;
  bool summary_only = 6;                // If true, return only daily summaries
}

message GetProcessingUsageResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated ProcessingUsageRecord records = 2;           // Detailed records (when summary_only=false)
  repeated ProcessingUsageSummary summaries = 3;        // Daily summaries
}

// ============================================================================
// Rebuffering Events (from rebuffering_events table)
// ============================================================================

// Rebuffering event capturing buffer state transitions
message RebufferingEvent {
  string id = 1;                                         // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;
  string tenant_id = 3;
  string stream_id = 4;
  string node_id = 5;
  string buffer_state = 6;                               // Current buffer state
  string prev_state = 7;                                 // Previous buffer state
  google.protobuf.Timestamp rebuffer_start = 8;          // When rebuffering started
  google.protobuf.Timestamp rebuffer_end = 9;            // When rebuffering ended
}

message GetRebufferingEventsRequest {
  string tenant_id = 1;
  optional string stream_id = 2;                         // Filter by stream
  optional string node_id = 3;                           // Filter by node
  common.TimeRange time_range = 4;
  common.CursorPaginationRequest pagination = 5;
}

message GetRebufferingEventsResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated RebufferingEvent events = 2;
}

// ============================================================================
// Tenant Analytics Daily (from tenant_analytics_daily table)
// ============================================================================

// Daily tenant-level analytics rollup
message TenantAnalyticsDaily {
  string id = 1;                                         // Unique ID for cursor pagination
  google.protobuf.Timestamp day = 2;
  string tenant_id = 3;
  int32 total_streams = 4;                               // Unique streams with activity
  int64 total_views = 5;                                 // Total view events
  int32 unique_viewers = 6;                              // Unique viewer count
  int64 egress_bytes = 7;                                // Total bytes delivered
}

message GetTenantAnalyticsDailyRequest {
  string tenant_id = 1;
  common.TimeRange time_range = 2;
  common.CursorPaginationRequest pagination = 3;
}

message GetTenantAnalyticsDailyResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated TenantAnalyticsDaily records = 2;
}

// ============================================================================
// Stream Analytics Daily (from stream_analytics_daily table)
// ============================================================================

// Daily stream-level analytics rollup
message StreamAnalyticsDaily {
  string id = 1;                                         // Unique ID for cursor pagination
  google.protobuf.Timestamp day = 2;
  string tenant_id = 3;
  string stream_id = 4;
  int64 total_views = 5;                                 // Total view events
  int32 unique_viewers = 6;                              // Unique viewer count
  int32 unique_countries = 7;                            // Geographic diversity
  int32 unique_cities = 8;                               // City-level diversity
  int64 egress_bytes = 9;                                // Total bytes delivered
}

message GetStreamAnalyticsDailyRequest {
  string tenant_id = 1;
  optional string stream_id = 2;                         // Filter by stream
  common.TimeRange time_range = 3;
  common.CursorPaginationRequest pagination = 4;
}

message GetStreamAnalyticsDailyResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated StreamAnalyticsDaily records = 2;
}

// ============================================================================
// Stream Analytics Summary (range aggregates, MV-only)
// ============================================================================

message QualityTierSummary {
  uint32 tier_2160p_minutes = 1;
  uint32 tier_1440p_minutes = 2;
  uint32 tier_1080p_minutes = 3;
  uint32 tier_720p_minutes = 4;
  uint32 tier_480p_minutes = 5;
  uint32 tier_sd_minutes = 6;
  uint32 codec_h264_minutes = 7;
  uint32 codec_h265_minutes = 8;
  uint32 codec_vp9_minutes = 9;
  uint32 codec_av1_minutes = 10;
}

message StreamAnalyticsSummary {
  string tenant_id = 1;
  string stream_id = 2;
  common.TimeRange time_range = 3;
  float range_avg_viewers = 4;
  uint32 range_peak_concurrent_viewers = 5;
  int64 range_total_views = 6;
  int64 range_total_sessions = 7;
  float range_avg_buffer_health = 8;
  uint32 range_avg_bitrate = 9;
  float range_avg_fps = 10;
  float range_packet_loss_rate = 11;
  float range_avg_connection_time = 12;
  float range_viewer_hours = 13;
  float range_egress_gb = 14;
  int64 range_unique_viewers = 15;
  int32 range_unique_countries = 16;
  int64 range_rebuffer_count = 17;
  int64 range_issue_count = 18;
  int64 range_buffer_dry_count = 19;
  QualityTierSummary range_quality = 20;
  float range_avg_session_seconds = 21;
  float range_avg_bytes_per_session = 22;
  // Share percentages (only set in bulk queries)
  optional float range_egress_share_percent = 23;
  optional float range_viewer_share_percent = 24;
  optional float range_viewer_hours_share_percent = 25;
  // Raw integer values for keyset pagination (avoids float precision loss)
  int64 range_egress_bytes = 26;
  int64 range_viewer_seconds = 27;
}

message GetStreamAnalyticsSummaryRequest {
  string tenant_id = 1;
  string stream_id = 2;
  common.TimeRange time_range = 3;
}

message GetStreamAnalyticsSummaryResponse {
  StreamAnalyticsSummary summary = 1;
}

// Sort field for bulk stream analytics summaries
enum StreamSummarySortField {
  STREAM_SUMMARY_SORT_FIELD_UNSPECIFIED = 0;
  STREAM_SUMMARY_SORT_FIELD_EGRESS_GB = 1;
  STREAM_SUMMARY_SORT_FIELD_UNIQUE_VIEWERS = 2;
  STREAM_SUMMARY_SORT_FIELD_TOTAL_VIEWS = 3;
  STREAM_SUMMARY_SORT_FIELD_VIEWER_HOURS = 4;
}

// Request for bulk stream analytics summaries
message GetStreamAnalyticsSummariesRequest {
  string tenant_id = 1;
  common.TimeRange time_range = 2;
  common.CursorPaginationRequest pagination = 3;
  StreamSummarySortField sort_by = 4;
  common.SortOrder sort_order = 5;
}

// Response for bulk stream analytics summaries
message GetStreamAnalyticsSummariesResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated StreamAnalyticsSummary summaries = 2;
  int64 total_count = 3;
}

// ============================================================================
// API Usage Analytics (from api_usage_hourly/daily tables)
// ============================================================================

// Hourly API usage record (from api_usage_hourly MV)
message APIUsageRecord {
  string id = 1;                                         // Unique ID for cursor pagination
  google.protobuf.Timestamp timestamp = 2;               // Hour timestamp
  string tenant_id = 3;
  string auth_type = 4;                                  // jwt, api_token, wallet, anonymous
  string operation_type = 5;                             // query, mutation, subscription
  string operation_name = 6;                             // GetStreams, CreateClip, etc.
  uint64 request_count = 7;
  uint64 error_count = 8;
  uint64 total_duration_ms = 9;
  uint64 total_complexity = 10;
  uint64 unique_users = 11;                              // Distinct user count in period
  uint64 unique_tokens = 12;                             // Distinct API token count in period
}

// Daily API usage summary (from api_usage_daily MV)
message APIUsageSummary {
  google.protobuf.Timestamp date = 1;
  string tenant_id = 2;
  string auth_type = 3;
  uint64 total_requests = 4;
  uint64 total_errors = 5;
  double avg_duration_ms = 6;
  uint64 total_complexity = 7;
  uint64 unique_users = 8;
  uint64 unique_tokens = 9;
}

// Operation-level API usage summary (from api_usage_hourly)
message APIUsageOperationSummary {
  string operation_type = 1;                       // query, mutation, subscription
  uint64 total_requests = 2;
  uint64 total_errors = 3;
  uint64 unique_operations = 4;                    // Distinct operation_name count
  double avg_duration_ms = 5;
  uint64 total_complexity = 6;
}

message GetAPIUsageRequest {
  string tenant_id = 1;
  common.TimeRange time_range = 2;
  optional string auth_type = 3;                         // Filter: jwt, api_token, wallet
  optional string operation_type = 4;                    // Filter: query, mutation, subscription
  common.CursorPaginationRequest pagination = 5;
  bool summary_only = 6;                                 // If true, return only daily summaries
  optional string operation_name = 7;                    // Filter: GraphQL operation name
}

message GetAPIUsageResponse {
  common.CursorPaginationResponse pagination = 1;
  repeated APIUsageRecord records = 2;                   // Hourly records (when summary_only=false)
  repeated APIUsageSummary summaries = 3;                // Daily summaries
  repeated APIUsageOperationSummary operation_summaries = 4;
}

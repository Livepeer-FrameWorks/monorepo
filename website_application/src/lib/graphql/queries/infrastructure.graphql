# Infrastructure management queries

# Fragments for reusable field selections
fragment NodeFields on Node {
  id
  nodeName
  clusterId
  nodeType
  status
  region
  externalIp
  internalIp
  wireguardIp
  availabilityZone
  cpuCores
  memoryGb
  diskGb
  lastHeartbeat
  createdAt
  latitude
  longitude
}

fragment ClusterFields on Cluster {
  id
  clusterId
  clusterName
  healthStatus
  createdAt
  isDefaultCluster
  isSubscribed
}

fragment NodeMetricHourlyFields on NodeMetricHourly {
  timestamp
  nodeId
  avgCpu
  peakCpu
  avgMemory
  peakMemory
  avgDisk
  peakDisk
  totalBandwidthIn
  totalBandwidthOut
  wasHealthy
}

# Combined query for infrastructure dashboard - fetches all data in one request
query GetInfrastructureOverview($timeRange: TimeRangeInput, $first: Int = 100, $noCache: Boolean = false) {
  tenant {
    id
    name
    cluster
    createdAt
  }

  clusters {
    ...ClusterFields
    nodes {
      ...NodeFields
    }
  }

  nodes {
    ...NodeFields
  }

  # Node metrics for performance data (1-hour aggregates)
  nodeMetrics1hConnection(timeRange: $timeRange, first: $first, noCache: $noCache) {
    edges {
      node {
        ...NodeMetricHourlyFields
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
    totalCount
  }
}

query GetTenant {
  tenant {
    id
    name
    cluster
    createdAt
  }
}

query GetClusters {
  clusters {
    ...ClusterFields
    nodes {
      id
      nodeName
      clusterId
      nodeType
      status
      region
      externalIp
      lastHeartbeat
      createdAt
      latitude
      longitude
    }
  }
}

query GetCluster($id: ID!) {
  cluster(id: $id) {
    ...ClusterFields
    nodes {
      id
      nodeName
      clusterId
      nodeType
      status
      region
      externalIp
      lastHeartbeat
      createdAt
      latitude
      longitude
    }
  }
}

query GetClustersAvailable {
  clustersAvailable {
    clusterId
    clusterName
    tiers
    autoEnroll
  }
}

# Clusters the current tenant can access (owner or subscriber)
query GetClustersAccess {
  clustersAccess {
    clusterId
    clusterName
    accessLevel
    resourceLimits
  }
}

query GetMySubscriptions {
  mySubscriptions {
    ...ClusterFields
  }
}

query GetNodes {
  nodes {
    id
    nodeName
    clusterId
    nodeType
    status
    region
    externalIp
    lastHeartbeat
    createdAt
    latitude
    longitude
  }
}

query GetNode($id: ID!) {
  node(id: $id) {
    id
    nodeName
    clusterId
    nodeType
    status
    region
    externalIp
    lastHeartbeat
    createdAt
    latitude
    longitude
  }
}

# Service Instances queries
fragment ServiceInstanceInfo on ServiceInstance {
  id
  instanceId
  clusterId
  nodeId
  serviceId
  version
  port
  processId
  containerId
  status
  healthStatus
  startedAt
  stoppedAt
  lastHealthCheck
}

query GetServiceInstances($clusterId: String) {
  serviceInstances(clusterId: $clusterId) {
    ...ServiceInstanceInfo
  }
}

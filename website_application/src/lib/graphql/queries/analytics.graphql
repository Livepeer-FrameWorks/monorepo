# Analytics queries
query GetStreamAnalytics($stream: String!, $timeRange: TimeRangeInput) {
  streamAnalytics(stream: $stream, timeRange: $timeRange) {
    # Core identifiers
    id
    streamId
    internalName

    # Session timing
    sessionStartTime
    sessionEndTime
    totalSessionDuration

    # Viewer metrics
    currentViewers
    peakViewers
    totalConnections

    # Bandwidth metrics
    bandwidthIn
    bandwidthOut
    totalBandwidthGb
    upbytes
    downbytes

    # Stream quality
    bitrateKbps
    resolution

    # Network performance
    packetsSent
    packetsLost
    packetsRetrans
    firstMs
    lastMs

    # Stream details
    trackCount
    inputs
    outputs

    # Location
    nodeId
    nodeName
    latitude
    longitude
    location

    # Status
    status
    lastUpdated
    createdAt

    # Current health state (from STREAM_BUFFER events)
    currentHealthScore
    currentBufferState
    currentIssues
    currentCodec
    currentFps
    currentResolution
    mistStatus
    qualityTier

    # Enriched analytics from ClickHouse (computed)
    avgViewers
    uniqueCountries
    uniqueCities
    avgBufferHealth
    avgBitrate
    packetLossRate

    # Aggregate viewer counts
    totalViews
    uniqueViewers
  }
}

query GetViewerMetrics($stream: String, $timeRange: TimeRangeInput) {
  viewerMetrics(stream: $stream, timeRange: $timeRange) {
    timestamp
    viewerCount
  }
}

# Time-bucketed viewer counts for charts (efficient ClickHouse aggregation)
query GetViewerCountTimeSeries(
  $stream: String
  $timeRange: TimeRangeInput
  $interval: String = "5m"
) {
  viewerCountTimeSeries(
    stream: $stream
    timeRange: $timeRange
    interval: $interval
  ) {
    timestamp
    viewerCount
    stream
  }
}

query GetPlatformOverview($timeRange: TimeRangeInput) {
  platformOverview(timeRange: $timeRange) {
    totalStreams
    totalViewers
    totalBandwidth
    totalUsers
    streamHours
    egressGb
    peakViewers
    totalUploadBytes
    totalDownloadBytes
    timeRange {
      start
      end
    }
  }
}

query GetUsageRecords($timeRange: TimeRangeInput) {
  usageRecords(timeRange: $timeRange) {
    id
    clusterId
    clusterName
    usageType
    usageValue
    billingMonth
    timestamp
  }
}

# Geographic Analytics queries
query GetViewerGeographics($stream: String, $timeRange: TimeRangeInput) {
  viewerGeographics(stream: $stream, timeRange: $timeRange) {
    timestamp
    stream
    nodeId
    countryCode
    city
    latitude
    longitude
    viewerCount
    connectionAddr
    eventType
    source
  }
}

query GetGeographicDistribution(
  $stream: String
  $timeRange: TimeRangeInput
  $topN: Int = 10
) {
  geographicDistribution(stream: $stream, timeRange: $timeRange, topN: $topN) {
    timeRange {
      start
      end
    }
    stream
    topCountries {
      countryCode
      viewerCount
      percentage
    }
    topCities {
      city
      countryCode
      viewerCount
      percentage
      latitude
      longitude
    }
    uniqueCountries
    uniqueCities
    totalViewers
    viewersByCountry {
      timestamp
      countryCode
      viewerCount
    }
  }
}

query GetLoadBalancingMetrics($timeRange: TimeRangeInput) {
  loadBalancingMetrics(timeRange: $timeRange) {
    timestamp
    stream
    selectedNode
    nodeId
    clientCountry
    clientLatitude
    clientLongitude
    clientBucket {
      h3Index
      resolution
    }
    nodeLatitude
    nodeLongitude
    nodeBucket {
      h3Index
      resolution
    }
    nodeName
    score
    status
    details
    routingDistance
    eventType
    source
    # Routing decision metadata
    candidatesCount
    latencyMs
  }
}

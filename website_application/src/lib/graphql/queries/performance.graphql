# Performance and aggregated analytics queries

# Service instance monitoring for performance (no Connection version - stays as array)
query GetPerformanceServiceInstances($clusterId: String) {
  serviceInstances(clusterId: $clusterId) {
    id
    instanceId
    clusterId
    nodeId
    serviceId
    version
    port
    processId
    containerId
    status
    healthStatus
    startedAt
    stoppedAt
    lastHealthCheck
    cpuUsagePercent
    memoryUsageMb
  }
}

# Platform-wide performance overview (node metrics only - viewer metrics use viewerCountTimeSeries)
query GetPlatformPerformance(
  $timeRange: TimeRangeInput
  $first: Int = 100
  $after: String
  $noCache: Boolean = false
) {
  nodeMetricsConnection(
    timeRange: $timeRange
    first: $first
    after: $after
    noCache: $noCache
  ) {
    edges {
      cursor
      node {
        timestamp
        nodeId
        cpuUsage
        memoryTotal
        memoryUsed
        diskTotal
        diskUsed
        shmTotal
        shmUsed
        status
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
    totalCount
  }
}

# Stream performance with routing data
query GetStreamPerformance(
  $stream: String!
  $timeRange: TimeRangeInput
  $first: Int = 100
  $after: String
  $noCache: Boolean = false
) {
  # Include routing performance for this stream
  routingEventsConnection(
    stream: $stream
    timeRange: $timeRange
    first: $first
    after: $after
    noCache: $noCache
  ) {
    edges {
      cursor
      node {
        timestamp
        selectedNode
        score
        status
        clientCountry
        nodeLatitude
        nodeLongitude
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
    totalCount
  }
}

# Node efficiency metrics combining performance and routing
query GetNodeEfficiency(
  $nodeId: String!
  $timeRange: TimeRangeInput
  $first: Int = 100
  $after: String
  $noCache: Boolean = false
) {
  nodeMetricsConnection(
    nodeId: $nodeId
    timeRange: $timeRange
    first: $first
    after: $after
    noCache: $noCache
  ) {
    edges {
      cursor
      node {
        timestamp
        nodeId
        cpuUsage
        memoryTotal
        memoryUsed
        diskTotal
        diskUsed
        shmTotal
        shmUsed
        networkRx
        networkTx
        status
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
    totalCount
  }

  # Get routing decisions made for this node
  routingEventsConnection(
    timeRange: $timeRange
    first: $first
    after: $after
    noCache: $noCache
  ) {
    edges {
      cursor
      node {
        timestamp
        streamName
        selectedNode
        score
        status
        clientCountry
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
    totalCount
  }
}

# Regional performance analysis (connection events for geographic data)
query GetRegionalPerformance(
  $timeRange: TimeRangeInput
  $first: Int = 100
  $after: String
  $noCache: Boolean = false
) {
  connectionEventsConnection(
    timeRange: $timeRange
    first: $first
    after: $after
    noCache: $noCache
  ) {
    edges {
      cursor
      node {
        timestamp
        nodeId
        countryCode
        city
        eventType
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
    totalCount
  }
}

# Fetch comprehensive stream health including metrics, issues, tracks, and client quality
# Returns detailed diagnostic data for stream monitoring and troubleshooting
query GetStreamHealth(
  $id: ID!
  $timeRange: TimeRangeInput
  $metricsFirst: Int = 100
) {
  stream(id: $id) {
    id
    name
    playbackId
    metrics {
      status
      isLive
      currentViewers
      bufferState
      qualityTier
      primaryWidth
      primaryHeight
      primaryFps
      primaryCodec
      primaryBitrate
      hasIssues
      issuesDescription
    }
    currentHealth {
      timestamp
      stream
      nodeId
      issuesDescription
      hasIssues
      bitrate
      fps
      width
      height
      codec
      qualityTier
      gopSize
      bufferState
      bufferHealth
      bufferSize
      audioCodec
      audioChannels
      audioSampleRate
      audioBitrate
    }
    analytics(timeRange: $timeRange) {
      avgBufferHealth
      avgBitrate
      packetLossRate
      qualityTier
      currentBufferState
      currentIssues
      packetsSent
      packetsLost
      packetsRetrans
    }
    healthConnection(timeRange: $timeRange, first: $metricsFirst) {
      edges {
        node {
          timestamp
          stream
          nodeId
          hasIssues
          issuesDescription
          bitrate
          fps
          width
          height
          codec
          qualityTier
          bufferState
          bufferHealth
        }
      }
      pageInfo {
        hasNextPage
        endCursor
      }
    }
    trackListConnection(timeRange: $timeRange, first: 50) {
      edges {
        node {
          timestamp
          stream
          nodeId
          trackList
          trackCount
          tracks {
            trackName
            trackType
            codec
            bitrateKbps
            width
            height
            fps
            buffer
            jitter
            channels
            sampleRate
            hasBFrames
          }
        }
      }
      pageInfo {
        hasNextPage
        endCursor
      }
    }
    rebufferingEventsConnection(timeRange: $timeRange, first: 100) {
      edges {
        node {
          timestamp
          stream
          nodeId
          bufferState
          previousState
          rebufferStart
          rebufferEnd
        }
      }
    }
    clientMetricsConnection(timeRange: $timeRange, first: $metricsFirst) {
      edges {
        node {
          timestamp
          internalName
          nodeId
          packetLossRate
          activeSessions
        }
      }
      pageInfo {
        hasNextPage
        endCursor
      }
    }
    # 5-minute health aggregates
    health5mConnection(timeRange: $timeRange, first: $metricsFirst) {
      edges {
        cursor
        node {
          id
          timestamp
          nodeId
          rebufferCount
          issueCount
          sampleIssues
          avgBitrate
          avgFps
          bufferDryCount
          qualityTier
        }
      }
      pageInfo {
        hasNextPage
        endCursor
      }
      totalCount
    }
  }
}
